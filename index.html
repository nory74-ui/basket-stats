<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Basketball Stats Pro JP v7.1</title>
    
    <style>
        /* --- Core System --- */
        :root {
            --bg-app: #000000;
            --bg-panel: #121212;
            --bg-card: #1e1e1e;
            --bg-hover: #2a2a2a;
            
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            
            --primary: #3b82f6; 
            --secondary: #ef4444;
            --accent: #eab308;
            --success: #22c55e;
            
            --border: 1px solid #333;
            --radius: 8px;
            --font-mono: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none; -webkit-user-select: none;
        }

        /* --- Utilities --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .grow { flex-grow: 1; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .font-mono { font-family: var(--font-mono); }
        .text-xs { font-size: 11px; }
        .text-sm { font-size: 13px; }
        .text-lg { font-size: 18px; }
        .text-xl { font-size: 20px; }
        .text-2xl { font-size: 28px; }
        .text-muted { color: var(--text-muted); }
        .text-white { color: white; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        
        /* Margins */
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        
        .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Scrollbar */
        .custom-scrollbar { 
            overflow-y: auto; 
            scrollbar-width: thin; 
            scrollbar-color: #444 transparent; 
            -webkit-overflow-scrolling: touch; /* iOS smooth scroll */
            overscroll-behavior: contain; /* Prevent body scroll */
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        /* --- Inputs & Buttons --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 12px; border-radius: var(--radius); cursor: pointer;
            background: var(--bg-card); color: var(--text-main); border: var(--border);
            transition: 0.1s; font-size: 13px; font-weight: 600;
        }
        .btn:active { transform: scale(0.96); filter: brightness(1.2); }
        .btn-ghost { background: transparent; border-color: transparent; }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn-success { background: var(--success); border-color: var(--success); color: black; }
        .btn-danger { color: var(--secondary); border-color: rgba(239,68,68,0.3); }
        
        .btn-sq { width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; }

        input, select {
            -webkit-appearance: none; appearance: none;
            display: block;
            background: var(--bg-card); border: var(--border); color: white;
            padding: 10px; border-radius: var(--radius); width: 100%;
            font-size: 14px;
            box-sizing: border-box;
        }

        /* --- Views Layout --- */
        .view-container { height: 100%; width: 100%; overflow: hidden; display: flex; flex-direction: column; }

        /* --- Setup / Team Edit --- */
        .setup-panel {
            max-width: 600px; width: 100%; margin: 0 auto;
            padding: 20px; display: flex; flex-direction: column; gap: 16px;
            overflow-y: auto;
        }
        .card { background: var(--bg-panel); border: var(--border); padding: 16px; border-radius: var(--radius); }
        .list-item { 
            display: flex; align-items: center; gap: 10px; 
            padding: 8px; background: var(--bg-card); border-radius: 4px; margin-bottom: 6px; 
        }

        /* --- History View --- */
        .history-item {
            background: var(--bg-card); border: var(--border); padding: 12px; border-radius: var(--radius);
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .score-box { background: #000; padding: 4px 8px; border-radius: 4px; margin: 0 8px; font-family: var(--font-mono); }

        /* --- Game: Main Layout --- */
        .main-layout {
            display: grid;
            grid-template-rows: auto 1fr; 
            height: 100%;
        }

        /* Scoreboard */
        .scoreboard {
            background: var(--bg-panel); border-bottom: var(--border);
            padding: 10px 20px; display: grid; grid-template-columns: 1fr auto 1fr;
            gap: 20px; align-items: flex-start; height: 170px; position: relative;
        }
        .team-display { display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; justify-content: center; min-width: 0; }
        
        .team-name-lg { font-size: 16px; font-weight: 700; letter-spacing: 0.5px; opacity: 0.9; text-align: center; width: 100%; }
        .total-score { font-size: 56px; font-weight: 900; line-height: 1; font-family: var(--font-mono); margin: 0; }
        .home-color { color: var(--primary); }
        .away-color { color: var(--secondary); }

        /* Exit Button */
        .exit-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
            color: #ccc; font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; z-index: 10;
        }

        /* Indicators */
        .indicator-row { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .indicator-label { font-size: 10px; font-weight: bold; color: var(--text-muted); width: 20px; text-align: right; }
        .indicator-ctrl { display: flex; align-items: center; gap: 4px; background: #111; padding: 2px; border-radius: 4px; border: 1px solid #333; }
        
        /* Dots */
        .dots-container { display: flex; gap: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #333; border: 1px solid #444; }
        .dot.active-red { background: var(--secondary); border-color: var(--secondary); box-shadow: 0 0 4px var(--secondary); }
        .dot.active-blue { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 4px var(--primary); }

        /* Period Board */
        .period-board {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #000; border: var(--border); border-radius: 6px; padding: 8px 12px;
            height: fit-content; align-self: center; width: 140px;
        }
        .period-control { font-size: 16px; font-weight: bold; color: var(--accent); cursor: pointer; margin-bottom: 6px; }
        
        /* Period Score Grid */
        .period-grid {
            display: grid; 
            grid-template-columns: repeat(5, 1fr);
            gap: 2px; width: 100%; text-align: center;
        }
        .pg-head { font-size: 9px; color: #666; font-family: monospace; margin-bottom: 2px; }
        .pg-val { font-size: 13px; font-weight: bold; padding: 2px 0; font-family: var(--font-mono); }
        .pg-val.home { color: var(--primary); }
        .pg-val.away { color: var(--secondary); }

        /* --- Cockpit Layout (Responsive) --- */
        .cockpit-grid {
            display: grid;
            height: 100%; overflow: hidden;
            background: var(--bg-app);
        }

        /* 1. Base / Desktop (> 1100px) - 5 Columns */
        .cockpit-grid {
            grid-template-columns: 180px 220px 1fr 220px 180px;
        }

        /* 2. Tablet Mode (701px - 1100px) - 3 Columns (Hide Logs) */
        @media (max-width: 1100px) {
            .cockpit-grid {
                grid-template-columns: 200px 1fr 200px;
            }
            /* Hide Log Panels (Col 1 & 5) */
            .cockpit-grid > .col-panel:nth-child(1),
            .cockpit-grid > .col-panel:nth-child(5) {
                display: none;
            }
        }

        .col-panel {
            display: flex; flex-direction: column; border-right: var(--border);
            overflow: hidden; background: var(--bg-panel);
        }
        .col-panel:last-child { border-right: none; }
        .col-header {
            padding: 6px; font-size: 10px; font-weight: bold; text-align: center;
            background: var(--bg-card); border-bottom: var(--border); color: var(--text-muted);
        }

        /* Log Items */
        .log-item {
            padding: 4px 8px; border-bottom: 1px solid #222; font-size: 10px; display: flex; gap: 6px;
        }
        .log-time { color: #555; font-family: monospace; min-width: 28px; }
        .log-txt { color: #ccc; }

        /* Roster Items (Enlarged) */
        .player-row {
            display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.1s;
            min-height: 54px; /* Larger touch area */
        }
        
        @media (hover: hover) {
            .player-row:hover { background: var(--bg-hover); }
            .exit-btn:hover { background: rgba(255,255,255,0.2); color: white; }
            .period-control:hover { color: white; }
            .act-btn:hover { filter: brightness(1.1); }
        }
        
        .player-row.selected-a { background: var(--primary); color: white; box-shadow: inset 6px 0 0 white; }
        .player-row.selected-b { background: var(--secondary); color: white; box-shadow: inset 6px 0 0 white; }
        
        .p-num { font-family: monospace; font-weight: bold; width: 32px; text-align: center; opacity: 0.8; font-size: 16px; }
        .p-name { flex-grow: 1; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px; }
        .p-stats { font-size: 11px; opacity: 0.9; display: flex; gap: 6px; font-family: var(--font-mono); }
        .stat-badge { background: rgba(0,0,0,0.4); padding: 2px 6px; border-radius: 4px; }

        /* Action Center */
        .action-area { background: var(--bg-app); display: flex; flex-direction: column; }
        .target-bar {
            height: 36px; display: flex; align-items: center; justify-content: center;
            border-bottom: var(--border); background: var(--bg-card);
            font-weight: bold; font-size: 12px;
        }
        .target-badge { padding: 3px 12px; border-radius: 12px; background: #333; color: #fff; }
        
        .action-buttons {
            flex: 1; padding: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(6, 1fr);
            gap: 6px;
        }
        .act-btn {
            background: linear-gradient(180deg, #2a2a2a, #202020);
            border: 1px solid #333; border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; box-shadow: 0 3px 0 #111;
            transition: transform 0.05s, box-shadow 0.05s;
        }
        .act-btn:active { transform: translateY(3px); box-shadow: none; }
        .act-btn.make { border-color: #22c55e; color: #22c55e; }
        .act-btn.miss { border-color: #ef4444; color: #ef4444; }
        .act-btn span:first-child { font-size: 16px; font-weight: 900; }
        .act-btn span:last-child { font-size: 9px; font-weight: 600; opacity: 0.8; margin-top: 1px; }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; padding: 8px; background: var(--bg-card); color: var(--text-muted); border-bottom: var(--border); position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid #222; }
        .num-cell { text-align: right; font-family: var(--font-mono); }

        /* --- [MOBILE] Phone Responsive (Tab Mode) - Only for < 700px --- */
        @media (max-width: 700px) {
            .cockpit-grid { display: flex; flex-direction: column; }
            .scoreboard { padding: 6px; gap: 6px; height: auto; grid-template-columns: 1fr 1fr; }
            .scoreboard > button { top: 4px; right: 4px; }
            .period-board { grid-column: span 2; order: 3; width: 100%; height: auto; padding: 4px; }
            .team-name-lg { font-size: 14px; }
            .total-score { font-size: 32px; }
            .period-grid { display: none; }

            .col-panel, .action-area { display: none; flex: 1; }
            .col-panel.mobile-active, .action-area.mobile-active { display: flex; }
            
            .cockpit-grid > .col-panel:nth-child(1),
            .cockpit-grid > .col-panel:nth-child(5) {
                display: flex; /* Restore logs in mobile tabs */
            }
            
            .mobile-tabs { display: flex; height: 48px; background: #111; border-top: var(--border); }
            .tab-btn { flex: 1; text-align: center; line-height: 48px; color: #666; font-weight: bold; cursor: pointer; font-size: 11px; }
            .tab-btn.active { color: white; background: #222; border-top: 2px solid var(--primary); }
        }
        
        /* --- [LANDSCAPE PHONE] Extra small landscape --- */
        @media (max-height: 500px) and (orientation: landscape) {
            .cockpit-grid {
                display: grid;
                grid-template-columns: 1fr 1.2fr 2fr 1.2fr 1fr; 
                flex: 1;
            }
            /* ... (keep previous styles for tiny landscape screens) ... */
            .mobile-tabs { display: none !important; }
            .col-panel { display: flex !important; }
            .action-area { display: flex !important; }
        }

        @media (min-width: 701px) { .mobile-tabs { display: none; } }

        /* Icons */
        .icon { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    </style>
</head>
<body>
    <div id="root" class="w-full h-full"></div>
    <input type="file" id="file-import" accept=".csv" style="display:none" onchange="Act.importTeams(event)">

    <script>
        // --- Utils ---
        const $ = (s) => document.querySelector(s);
        const genId = () => Math.random().toString(36).substr(2, 9);
        const nowTime = () => new Date().toTimeString().slice(0,5);
        
        const today = () => {
            const d = new Date();
            return `${d.getFullYear()}-${('0' + (d.getMonth() + 1)).slice(-2)}-${('0' + d.getDate()).slice(-2)}`;
        };

        const downloadStringAsFile = (filename, text) => {
            // Add BOM (Byte Order Mark) for Excel to recognize UTF-8
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, text], {type: 'text/csv;charset=utf-8;'});
            
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };
        
        // --- Icons ---
        const Icons = {
            Undo: `<svg class="icon"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>`,
            Trash: `<svg class="icon"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
            Refresh: `<svg class="icon"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>`,
            Plus: `<svg class="icon"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
            Minus: `<svg class="icon"><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
            List: `<svg class="icon"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
            Download: `<svg class="icon"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
            Upload: `<svg class="icon"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
            Exit: `<svg class="icon"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`
        };

        // --- State ---
        var State = {
            view: 'SETUP', 
            teams: [],
            history: [],
            editTeamId: null,
            viewHistoryId: null,
            match: null, 
            target: { side: null, id: null },
            mobileTab: 'CENTER',
            subModal: false,
            endModal: false,
            statsModal: false
        };

        // --- Data Persistence ---
        var load = () => {
            try {
                const dt = localStorage.getItem('bst_v6_data');
                const dh = localStorage.getItem('bst_v6_history');
                if(dt) State.teams = JSON.parse(dt);
                else {
                    State.teams = [
                        {id:genId(), name:'ホームチーム', players:genPlayers('4-18')},
                        {id:genId(), name:'アウェイチーム', players:genPlayers('4-18')}
                    ];
                    saveTeams();
                }
                if(dh) State.history = JSON.parse(dh);
            } catch (e) {
                console.error("Data load error", e);
                State.teams = [{id:genId(), name:'HOME', players:genPlayers('4-18')},{id:genId(), name:'AWAY', players:genPlayers('4-18')}];
            }
        };
        var saveTeams = () => localStorage.setItem('bst_v6_data', JSON.stringify(State.teams));
        var saveHistory = () => localStorage.setItem('bst_v6_history', JSON.stringify(State.history));
        
        var genPlayers = (mode) => {
            if(mode === '0-100') {
                return Array.from({length:101}, (_,i)=>({id:genId(), name:`選手 ${i}`, number:`${i}`}));
            }
            // Default 4-18 (15 players)
            return Array.from({length:15}, (_,i)=>({id:genId(), name:`選手 ${4+i}`, number:`${4+i}`}));
        };

        // Helper to check if player has played
        var checkPlayed = (p) => {
            if (p.hasPlayed !== undefined) return p.hasPlayed;
            // Fallback for older data
            const s = p.stats;
            return (s.pts + s.fga + s.tpa + s.fta + s.orb + s.drb + s.ast + s.tov + s.pf) > 0 || p.isOnCourt;
        };

        // --- Actions ---
        var Act = {
            setView: (v) => { State.view = v; Render(); },

            // History
            deleteHistory: (id) => {
                if(confirm('この履歴を削除しますか？')) {
                    State.history = State.history.filter(h => h.id !== id);
                    saveHistory();
                    if(State.viewHistoryId === id) Act.setView('HISTORY');
                    else Render();
                }
            },
            viewHistory: (id) => { State.viewHistoryId = id; Act.setView('HISTORY_DETAIL'); },
            
            // Export
            exportOne: (id) => {
                const m = State.history.find(h => h.id === id);
                if(!m) return;
                const csv = generateMatchCSV(m);
                copyToClipboard(csv);
            },
            exportAll: () => {
                let allCsv = "";
                State.history.forEach(m => {
                    allCsv += generateMatchCSV(m) + "\n\n" + "=".repeat(20) + "\n\n";
                });
                copyToClipboard(allCsv);
            },

            // Team Mgmt
            createTeam: (mode) => {
                const newTeam = { id: genId(), name: '新規チーム', players: genPlayers(mode) };
                State.teams.push(newTeam); saveTeams(); Act.editTeam(newTeam.id);
            },
            editTeam: (id) => { State.editTeamId = id; State.view = 'EDIT_TEAM'; Render(); },
            deleteTeam: (id) => { if(confirm('削除しますか？')) { State.teams=State.teams.filter(t=>t.id!==id); saveTeams(); Render(); } },
            updateTeamName: (val) => { State.teams.find(t=>t.id===State.editTeamId).name = val; saveTeams(); },
            addPlayer: () => { State.teams.find(t=>t.id===State.editTeamId).players.push({id:genId(), name:'新規選手', number:''}); saveTeams(); Render(); },
            removePlayer: (pid) => { const t=State.teams.find(t=>t.id===State.editTeamId); t.players=t.players.filter(p=>p.id!==pid); saveTeams(); Render(); },
            updatePlayer: (pid, key, val) => { const t=State.teams.find(t=>t.id===State.editTeamId); const p=t.players.find(p=>p.id===pid); if(p){p[key]=val; saveTeams();} },
            
            // Team CSV
            triggerImport: () => $('#file-import').click(),
            importTeams: (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    const lines = text.split(/\r\n|\n/);
                    const newTeams = {};
                    let count = 0;
                    lines.forEach((line, i) => {
                        if(i===0 && line.includes('TEAM_NAME')) return; // header check
                        const cols = line.split(',');
                        if(cols.length >= 3) {
                            const tName = cols[0].trim();
                            const pNum = cols[1].trim();
                            const pName = cols[2].trim();
                            if(tName) {
                                if(!newTeams[tName]) newTeams[tName] = [];
                                newTeams[tName].push({id:genId(), number:pNum, name: pName || `選手 ${pNum}`});
                                count++;
                            }
                        }
                    });
                    
                    if(count === 0) return alert('有効なデータが見つかりませんでした');
                    
                    Object.keys(newTeams).forEach(k => {
                        State.teams.push({id:genId(), name:k, players:newTeams[k]});
                    });
                    saveTeams();
                    Render();
                    alert(`${Object.keys(newTeams).length}チームをインポートしました`);
                    e.target.value = ''; // Reset input
                };
                reader.readAsText(file);
            },
            exportTeams: () => {
                let csv = "TEAM_NAME,NUMBER,PLAYER_NAME\n";
                State.teams.forEach(t => {
                    t.players.forEach(p => {
                        csv += `${t.name},${p.number},${p.name}\n`;
                    });
                });
                copyToClipboard(csv);
            },
            downloadTemplate: () => {
                const csv = "TEAM_NAME,NUMBER,PLAYER_NAME\nサンプルチーム,4,田中 太郎\nサンプルチーム,5,佐藤 次郎";
                downloadStringAsFile('member_template.csv', csv);
            },

            // Match Logic
            start: () => {
                const hid = $('#sel-home').value;
                const aid = $('#sel-away').value;
                if(!hid || !aid) return alert('チームを選択してください');
                
                const h = State.teams.find(t=>t.id===hid);
                const a = State.teams.find(t=>t.id===aid);
                
                // Initialize players with hasPlayed flag
                const initP = (pl) => pl.map((p,i) => ({
                    ...p, 
                    stats: initStats(), 
                    isOnCourt: i<5, 
                    hasPlayed: i<5
                }));

                State.match = {
                    id: genId(),
                    info: { date:$('#inp-date').value, title:$('#inp-title').value },
                    A: { ...h, players: initP(h.players) },
                    B: { ...a, players: initP(a.players) },
                    log: [], history: [], period: 1,
                    timeouts: { A: 0, B: 0 } 
                };
                State.view = 'GAME'; 
                State.target = { side: null, id: null };
                State.statsModal = false;
                State.endModal = false;
                State.subModal = false;
                Render();
            },
            
            sel: (s, id) => { 
                // Toggle if same ID, otherwise select
                State.target = (State.target.id === id) ? {side:null, id:null} : {side:s, id:id}; 
                Render(); 
            },

            stat: (k) => {
                if(!State.target.side) return alert('選手またはチームを選択してください');
                const m = State.match;
                
                m.history.push(JSON.stringify({A:m.A, B:m.B, log:m.log, period:m.period, timeouts:m.timeouts}));
                
                const s = State.target.side;
                const tm = m[s];
                const pl = tm.players.find(p => p.id === State.target.id);
                const st = pl ? pl.stats : null;
                
                let pts = 0;
                if(k.includes('3PM')) { pts=3; if(st){st.fgm++; st.fga++; st.tpm++; st.tpa++;} }
                else if(k.includes('3PX')) { if(st){st.fga++; st.tpa++;} }
                else if(k.includes('2PM')) { pts=2; if(st){st.fgm++; st.fga++;} }
                else if(k.includes('2PX')) { if(st){st.fga++;} }
                else if(k.includes('FTM')) { pts=1; if(st){st.ftm++; st.fta++;} }
                else if(k.includes('FTX')) { if(st){st.fta++;} }
                else if(k==='ORB') { if(st) st.orb++; }
                else if(k==='DRB') { if(st) st.drb++; }
                else if(k==='AST') { if(st) st.ast++; }
                else if(k==='TOV') { if(st) st.tov++; }
                else if(k==='PF') { if(st) st.pf++; }
                
                if(pts > 0 && st) st.pts += pts;

                m.log.unshift({
                    id: genId(), time: nowTime(), period: m.period,
                    side: s, pts: pts, isFoul: k === 'PF',
                    txt: `${pl?`#${pl.number}`:'チーム'} ${k}`
                });
                Render();
            },

            setPeriod: (p) => { State.match.period = p > 4 ? (p>5?1:5) : p; Render(); },

            timeout: (side, delta) => {
                const m = State.match;
                const newVal = m.timeouts[side] + delta;
                
                if (newVal < 0 || newVal > 5) return;

                m.history.push(JSON.stringify({A:m.A, B:m.B, log:m.log, period:m.period, timeouts:m.timeouts}));
                m.timeouts[side] = newVal;
                
                if (delta > 0) {
                    m.log.unshift({id:genId(), time:nowTime(), period:m.period, side:side, txt:'タイムアウト取得'});
                }
                Render();
            },

            undo: () => {
                if(State.match.history.length) {
                    const p = JSON.parse(State.match.history.pop());
                    State.match.A = p.A; State.match.B = p.B; State.match.log = p.log; 
                    State.match.period = p.period; State.match.timeouts = p.timeouts;
                    Render();
                }
            },

            // Stats Modal
            openStats: () => { State.statsModal = true; Render(); },
            closeStats: () => { State.statsModal = false; Render(); },

            // Game Control
            openEnd: () => { State.endModal = true; Render(); },
            closeEnd: () => { State.endModal = false; Render(); },
            
            finish: (save) => {
                if(save) {
                    const sc = calcScores(State.match);
                    const finalMatch = {
                        ...State.match,
                        history: [], 
                        finalScore: { A: sc.At, B: sc.Bt, detail: sc }
                    };
                    State.history.unshift(finalMatch);
                    saveHistory();
                }
                State.match = null;
                State.endModal = false;
                State.statsModal = false;
                State.view = 'SETUP';
                Render();
            },

            // Sub
            openSub: () => { State.subModal = true; Render(); },
            execSub: (side, outId, inId) => {
                const t = State.match[side];
                t.players.find(p=>p.id===outId).isOnCourt = false;
                const inP = t.players.find(p=>p.id===inId);
                inP.isOnCourt = true;
                inP.hasPlayed = true; // Mark as played
                State.match.log.unshift({time:nowTime(), period:State.match.period, side:side, txt:`交代 IN #${inP.number}`});
                State.subModal = false;
                window.subOut = null; 
                window.subIn = null;
                Render();
            }
        };

        var initStats = () => ({pts:0, fgm:0, fga:0, tpm:0, tpa:0, ftm:0, fta:0, orb:0, drb:0, ast:0, tov:0, pf:0});

        var calcScores = (m) => {
            const scores = {A:[0,0,0,0,0], B:[0,0,0,0,0], At:0, Bt:0}; 
            m.log.forEach(l => {
                if(l.pts) {
                    const idx = l.period - 1;
                    if(idx >= 0 && idx <= 4) scores[l.side][idx] += l.pts;
                    scores[l.side+'t'] += l.pts;
                }
            });
            return scores;
        };

        var calcTeamFouls = (m) => {
            const f = {A:0, B:0};
            m.log.forEach(l => { 
                if(l.period === m.period && (l.isFoul || l.txt.includes('PF'))) f[l.side]++; 
            });
            return f;
        };

        var generateMatchCSV = (m) => {
            let tsv = `DATE,${m.info.date}\nTITLE,${m.info.title}\n\n`;
            ['A', 'B'].forEach(s => {
                const t = m[s];
                tsv += `TEAM,${t.name}\n`;
                tsv += `No,Name,PTS,REB,AST,TOV,PF,FGM,FGA,3PM,3PA,FTM,FTA\n`;
                t.players.forEach(p => {
                    if(checkPlayed(p)) {
                        const st = p.stats;
                        tsv += `${p.number},${p.name},${st.pts},${st.orb+st.drb},${st.ast},${st.tov},${st.pf},${st.fgm},${st.fga},${st.tpm},${st.tpa},${st.ftm},${st.fta}\n`;
                    }
                });
                const l = m.log.filter(x=>x.side===s);
                const pts = l.reduce((a,b)=>a+(b.pts||0),0);
                tsv += `TOTAL,,${pts}\n\n`;
            });
            return tsv;
        };

        var copyToClipboard = (text) => {
            const el = document.createElement("textarea");
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert('クリップボードにコピーしました。Excel等に貼り付けてください。');
        };

        // --- Views ---
        var Render = () => {
            const root = $('#root');
            switch(State.view) {
                case 'SETUP': root.innerHTML = SetupView(); break;
                case 'HISTORY': root.innerHTML = HistoryListView(); break;
                case 'HISTORY_DETAIL': root.innerHTML = HistoryDetailView(); break;
                case 'EDIT_LIST': root.innerHTML = TeamListView(); break;
                case 'EDIT_TEAM': root.innerHTML = TeamEditView(); break;
                case 'GAME': root.innerHTML = GameView(); break;
            }
        };

        var SetupView = () => `
            <div class="view-container items-center justify-center p-4">
                <h1 class="text-2xl font-bold mb-6 tracking-tight">BASKETBALL STATS PRO</h1>
                <div class="setup-panel border border-[#333] rounded-lg bg-panel">
                    <div class="mb-4">
                        <label class="text-xs text-muted font-bold">試合情報</label>
                        <input id="inp-date" type="date" value="${today()}" class="mb-2">
                        <input id="inp-title" value="公式戦">
                    </div>
                    <div class="mb-6">
                        <label class="text-xs text-muted font-bold">対戦カード</label>
                        <div class="flex gap-2 items-center">
                            <select id="sel-home">${State.teams.map(t=>`<option value="${t.id}">${t.name}</option>`)}</select>
                            <span class="font-bold text-muted text-xs">VS</span>
                            <select id="sel-away">${State.teams.map(t=>`<option value="${t.id}">${t.name}</option>`)}</select>
                        </div>
                    </div>
                    <button onclick="Act.start()" class="btn btn-primary w-full p-3 text-lg mb-4 shadow-lg">試合開始 (START)</button>
                    
                    <div class="grid grid-cols-2 gap-2 border-t border-[#333] pt-4 flex">
                         <button onclick="Act.setView('HISTORY')" class="btn text-muted border-dashed grow">${Icons.List} 履歴・分析</button>
                         <button onclick="Act.setView('EDIT_LIST')" class="btn text-muted border-dashed grow">チーム管理</button>
                    </div>
                </div>
            </div>
        `;

        var HistoryListView = () => `
            <div class="view-container p-4">
                <div class="setup-panel h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-xl">試合履歴</h2>
                        <div class="flex gap-2">
                            <button onclick="Act.exportAll()" class="btn btn-success text-xs">${Icons.Download} 全データ出力</button>
                            <button onclick="Act.setView('SETUP')" class="btn">戻る</button>
                        </div>
                    </div>
                    <div class="custom-scrollbar grow">
                        ${State.history.length === 0 ? '<div class="text-muted text-center p-4">履歴がありません</div>' : ''}
                        ${State.history.map(h => `
                            <div class="history-item">
                                <div class="flex-1 cursor-pointer" onclick="Act.viewHistory('${h.id}')">
                                    <div class="text-xs text-muted">${h.info.date}</div>
                                    <div class="font-bold text-sm mb-1">${h.info.title}</div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-primary font-bold truncate" style="max-width:100px">${h.A.name}</span>
                                        <span class="score-box">${h.finalScore.A} - ${h.finalScore.B}</span>
                                        <span class="text-secondary font-bold truncate" style="max-width:100px">${h.B.name}</span>
                                    </div>
                                </div>
                                <button onclick="Act.deleteHistory('${h.id}')" class="btn btn-ghost text-muted hover:text-red-500">${Icons.Trash}</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        var HistoryDetailView = () => {
            const m = State.history.find(h => h.id === State.viewHistoryId);
            if(!m) return Act.setView('HISTORY');
            
            const StatTable = (side) => {
                const t = m[side];
                return `
                    <div class="mb-4">
                        <div class="font-bold mb-1 text-xs px-1" style="color:${side==='A'?'var(--primary)':'var(--secondary)'}">${t.name}</div>
                        <table>
                            <thead><tr><th># Name</th><th class="text-right">PTS</th><th class="text-right">REB</th><th class="text-right">AST</th><th class="text-right">FG</th><th class="text-right">3P</th><th class="text-right">FT</th><th class="text-right">PF</th></tr></thead>
                            <tbody>
                                ${t.players.filter(p => checkPlayed(p)).map(p => {
                                    const s = p.stats;
                                    return `<tr>
                                        <td><span class="font-mono text-muted mr-1">${p.number}</span> ${p.name}</td>
                                        <td class="num-cell font-bold text-white">${s.pts}</td>
                                        <td class="num-cell">${s.orb+s.drb}</td>
                                        <td class="num-cell">${s.ast}</td>
                                        <td class="num-cell text-muted">${s.fgm}/${s.fga}</td>
                                        <td class="num-cell text-muted">${s.tpm}/${s.tpa}</td>
                                        <td class="num-cell text-muted">${s.ftm}/${s.fta}</td>
                                        <td class="num-cell">${s.pf}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            return `
            <div class="view-container p-4">
                <div class="setup-panel h-full" style="max-width:800px;">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="text-xs text-muted">${m.info.date}</div>
                            <div class="font-bold text-lg">${m.info.title}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="Act.exportOne('${m.id}')" class="btn btn-success text-xs">${Icons.Download} CSV</button>
                            <button onclick="Act.setView('HISTORY')" class="btn">戻る</button>
                        </div>
                    </div>
                    <div class="bg-card p-4 rounded text-center mb-4 text-2xl font-black font-mono flex justify-center items-center gap-4">
                        <span class="text-primary truncate flex-1 text-right">${m.A.name}</span>
                        <span class="bg-black px-4 py-1 rounded border border-[#333]">${m.finalScore.A} - ${m.finalScore.B}</span>
                        <span class="text-secondary truncate flex-1 text-left">${m.B.name}</span>
                    </div>
                    <div class="custom-scrollbar grow">
                        ${StatTable('A')}
                        ${StatTable('B')}
                    </div>
                </div>
            </div>
            `;
        };

        var TeamListView = () => `
            <div class="view-container p-4">
                <div class="setup-panel h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-xl">チーム管理</h2>
                        <button onclick="Act.setView('SETUP')" class="btn">戻る</button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="Act.triggerImport()" class="btn border-dashed text-muted text-xs">${Icons.Upload} CSV読込 (追加)</button>
                        <button onclick="Act.exportTeams()" class="btn border-dashed text-muted text-xs">${Icons.Download} CSV保存 (全件)</button>
                        <button onclick="Act.downloadTemplate()" class="btn border-dashed text-muted text-xs col-span-2">${Icons.Download} 登録用CSV雛形をダウンロード</button>
                    </div>
                    
                    <div class="flex flex-col gap-2 mb-4 p-2 border border-[#333] rounded bg-card">
                        <label class="text-xs text-muted font-bold text-center">新規チーム作成 (プリセット選択)</label>
                        <div class="flex gap-2">
                            <button onclick="Act.createTeam('4-18')" class="btn btn-primary grow text-xs">No.4 - 18 (15名)</button>
                            <button onclick="Act.createTeam('0-100')" class="btn btn-primary grow text-xs">No.0 - 100 (101名)</button>
                        </div>
                    </div>

                    <div class="custom-scrollbar grow">
                        ${State.teams.map(t => `
                            <div class="card mb-2 flex justify-between items-center">
                                <span class="font-bold">${t.name}</span>
                                <div class="flex gap-2">
                                    <button onclick="Act.editTeam('${t.id}')" class="btn text-xs">編集</button>
                                    <button onclick="Act.deleteTeam('${t.id}')" class="btn btn-danger text-xs">削除</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        var TeamEditView = () => {
            const t = State.teams.find(x => x.id === State.editTeamId);
            return `
            <div class="view-container p-4">
                <div class="setup-panel h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg">チーム編集</h2>
                        <button onclick="Act.setView('EDIT_LIST')" class="btn">完了</button>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-muted">チーム名</label>
                        <input value="${t.name}" oninput="Act.updateTeamName(this.value)" class="text-lg font-bold mt-1">
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-muted">メンバー (${t.players.length})</span>
                        <button onclick="Act.addPlayer()" class="btn text-xs">${Icons.Plus} 追加</button>
                    </div>
                    <div class="custom-scrollbar grow">
                        ${t.players.map(p => `
                            <div class="list-item">
                                <input value="${p.number}" placeholder="#" onchange="Act.updatePlayer('${p.id}','number',this.value)" style="width:50px; text-align:center; font-family:monospace; font-weight:bold;">
                                <input value="${p.name}" placeholder="名前" onchange="Act.updatePlayer('${p.id}','name',this.value)" style="flex:1">
                                <button onclick="Act.removePlayer('${p.id}')" class="btn btn-ghost text-muted hover:text-red-500">${Icons.Trash}</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            `;
        };

        var GameView = () => {
            const m = State.match;
            const t = State.target;
            const sc = calcScores(m);
            const tf = calcTeamFouls(m);

            // Sub Modal
            let subHTML = '';
            if(State.subModal) {
                const s = t.side || 'A';
                const tm = m[s];
                subHTML = `
                    <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm">
                        <div class="bg-card w-11/12 max-w-md p-4 rounded border border-[#444] shadow-2xl">
                            <h3 class="font-bold mb-4 flex justify-between items-center">
                                <span>選手交代: ${tm.name}</span>
                            </h3>
                            <div class="flex gap-2 h-64">
                                <div class="flex-1 overflow-y-auto border-r border-[#333] pr-1">
                                    <div class="text-xs text-secondary text-center font-bold mb-2">COURT (OUT)</div>
                                    ${tm.players.filter(p=>p.isOnCourt).map(p=>`
                                        <button onclick="window.subOut='${p.id}'; this.parentElement.querySelectorAll('button').forEach(b=>b.style.background=''); this.style.background='var(--secondary)'" class="btn w-full mb-1 justify-between text-left p-2">
                                            <span class="font-mono font-bold w-6">${p.number}</span> <span class="truncate">${p.name}</span>
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="flex-1 overflow-y-auto pl-1">
                                    <div class="text-xs text-primary text-center font-bold mb-2">BENCH (IN)</div>
                                    ${tm.players.filter(p=>!p.isOnCourt).map(p=>`
                                        <button onclick="window.subIn='${p.id}'; this.parentElement.querySelectorAll('button').forEach(b=>b.style.background=''); this.style.background='var(--primary)'" class="btn w-full mb-1 justify-between text-left p-2">
                                            <span class="font-mono font-bold w-6">${p.number}</span> <span class="truncate">${p.name}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button onclick="State.subModal=false;Render()" class="btn flex-1">閉じる</button>
                                <button onclick="if(window.subOut&&window.subIn) Act.execSub('${s}',window.subOut,window.subIn)" class="btn btn-primary flex-1 font-bold">交代実行</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Stats Modal
            let statsHTML = '';
            if(State.statsModal) {
                const StatTableRow = (p) => {
                    const s = p.stats;
                    return `
                        <tr>
                            <td class="py-2 border-b border-[#333]"><span class="font-mono text-muted mr-1">${p.number}</span> ${p.name}</td>
                            <td class="num-cell font-bold text-white border-b border-[#333]">${s.pts}</td>
                            <td class="num-cell border-b border-[#333]">${s.orb+s.drb}</td>
                            <td class="num-cell border-b border-[#333]">${s.ast}</td>
                            <td class="num-cell text-muted border-b border-[#333]">${s.fgm}/${s.fga}</td>
                            <td class="num-cell text-muted border-b border-[#333]">${s.tpm}/${s.tpa}</td>
                            <td class="num-cell text-muted border-b border-[#333]">${s.ftm}/${s.fta}</td>
                            <td class="num-cell border-b border-[#333]">${s.pf}</td>
                        </tr>
                    `;
                };

                const TeamStats = (side) => {
                    const tm = m[side];
                    // Calculate Totals
                    const totals = tm.players.reduce((acc, p) => {
                        const s = p.stats;
                        acc.pts += s.pts;
                        acc.reb += (s.orb + s.drb);
                        acc.ast += s.ast;
                        acc.fgm += s.fgm; acc.fga += s.fga;
                        acc.tpm += s.tpm; acc.tpa += s.tpa;
                        acc.ftm += s.ftm; acc.fta += s.fta;
                        acc.pf += s.pf;
                        return acc;
                    }, {pts:0, reb:0, ast:0, fgm:0, fga:0, tpm:0, tpa:0, ftm:0, fta:0, pf:0});

                    return `
                        <div class="mb-6">
                            <div class="font-bold mb-2 text-sm sticky top-0 bg-panel py-1 z-10 border-b border-[#333]" style="color:${side==='A'?'var(--primary)':'var(--secondary)'}">${tm.name}</div>
                            <table class="w-full">
                                <thead>
                                    <tr>
                                        <th class="text-xs text-muted font-normal border-b border-[#333] pb-1">Name</th>
                                        <th class="text-xs text-muted font-normal text-right border-b border-[#333] pb-1">PTS</th>
                                        <th class="text-xs text-muted font-normal text-right border-b border-[#333] pb-1">REB</th>
                                        <th class="text-xs text-muted font-normal text-right border-b border-[#333] pb-1">AST</th>
                                        <th class="text-xs text-muted font-normal text-right border-b border-[#333] pb-1">FG</th>
                                        <th class="text-xs text-muted font-normal text-right border-b border-[#333] pb-1">3P</th>
                                        <th class="text-xs text-muted font-normal text-right border-b border-[#333] pb-1">FT</th>
                                        <th class="text-xs text-muted font-normal text-right border-b border-[#333] pb-1">PF</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tm.players.map(p => StatTableRow(p)).join('')}
                                </tbody>
                                <tfoot>
                                    <tr class="font-bold bg-white/5">
                                        <td class="py-2 border-t border-[#444]">TOTAL</td>
                                        <td class="num-cell border-t border-[#444] text-white">${totals.pts}</td>
                                        <td class="num-cell border-t border-[#444]">${totals.reb}</td>
                                        <td class="num-cell border-t border-[#444]">${totals.ast}</td>
                                        <td class="num-cell border-t border-[#444] text-muted font-normal text-xs">${totals.fgm}/${totals.fga}</td>
                                        <td class="num-cell border-t border-[#444] text-muted font-normal text-xs">${totals.tpm}/${totals.tpa}</td>
                                        <td class="num-cell border-t border-[#444] text-muted font-normal text-xs">${totals.ftm}/${totals.fta}</td>
                                        <td class="num-cell border-t border-[#444]">${totals.pf}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                };

                statsHTML = `
                    <div class="fixed inset-0 bg-black/90 flex flex-col z-50 backdrop-blur-sm h-full w-full">
                        <div class="flex justify-between items-center p-4 border-b border-[#333] bg-panel shrink-0">
                            <h3 class="font-bold text-lg">現在のスタッツ</h3>
                            <button onclick="Act.closeStats()" class="btn btn-ghost text-2xl w-10 h-10 flex items-center justify-center">×</button>
                        </div>
                        <div class="overflow-y-auto flex-1 p-4 custom-scrollbar w-full" style="-webkit-overflow-scrolling: touch;">
                            <div class="max-w-3xl mx-auto pb-24">
                                ${TeamStats('A')}
                                ${TeamStats('B')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // End Modal
            if(State.endModal) {
                subHTML = `
                    <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm">
                        <div class="bg-card w-full max-w-sm p-6 rounded border border-[#444] text-center shadow-2xl">
                            <h3 class="font-bold text-xl mb-2 text-white">試合終了</h3>
                            <p class="text-muted text-sm mb-6">試合結果を保存してメニューに戻りますか？</p>
                            <div class="flex flex-col gap-3">
                                <button onclick="Act.finish(true)" class="btn btn-primary w-full p-3 font-bold">保存して終了</button>
                                <button onclick="Act.finish(false)" class="btn btn-danger w-full p-3">保存せずに破棄</button>
                                <button onclick="Act.closeEnd()" class="btn btn-ghost w-full p-3">キャンセル</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Period Table Rows (Home/Away separated)
            const PeriodRows = () => {
                const sA = sc['A'];
                const sB = sc['B'];
                let header = `<div class="pg-head">1</div><div class="pg-head">2</div><div class="pg-head">3</div><div class="pg-head">4</div><div class="pg-head">OT</div>`;
                let rowA = `<div class="pg-val home">${sA[0]}</div><div class="pg-val home">${sA[1]}</div><div class="pg-val home">${sA[2]}</div><div class="pg-val home">${sA[3]}</div><div class="pg-val home">${sA[4]}</div>`;
                let rowB = `<div class="pg-val away">${sB[0]}</div><div class="pg-val away">${sB[1]}</div><div class="pg-val away">${sB[2]}</div><div class="pg-val away">${sB[3]}</div><div class="pg-val away">${sB[4]}</div>`;
                return header + rowA + rowB;
            };

            const Indicators = (side, count, colorClass) => {
                let dots = '';
                for(let i=0; i<5; i++) {
                    dots += `<div class="dot ${i < count ? colorClass : ''}"></div>`;
                }
                return dots;
            };

            const Roster = (side) => {
                const tm = m[side];
                const color = side==='A'?'selected-a':'selected-b';
                return tm.players.filter(p=>p.isOnCourt).map(p => `
                    <div onclick="Act.sel('${side}','${p.id}')" class="player-row ${t.id===p.id && t.side===side ? color : ''}">
                        <div class="p-num">${p.number}</div>
                        <div class="p-name">${p.name}</div>
                        <div class="p-stats">
                            <span class="stat-badge">PTS:${p.stats.pts}</span>
                            <span class="stat-badge">F:${p.stats.pf}</span>
                        </div>
                    </div>
                `).join('') + `<div class="p-2 text-center mt-auto"><button onclick="State.target.side='${side}';Act.openSub()" class="btn btn-ghost text-xs text-muted w-full border border-dashed border-[#333] hover:bg-white/5">交代 (SUB)</button></div>`;
            };

            const Logs = (side) => m.log.filter(l=>l.side===side).map(l => `<div class="log-item"><span class="log-time">${l.time}</span><span class="log-txt">${l.txt}</span></div>`).join('');

            return `
                ${subHTML}
                ${statsHTML}
                <div class="main-layout">
                    <!-- SCOREBOARD -->
                    <div class="scoreboard">
                        <button onclick="Act.openEnd()" class="exit-btn flex items-center gap-1">${Icons.Exit} 終了</button>
                        
                        <!-- HOME -->
                        <div class="team-display home-color">
                            <div class="team-name-lg truncate">${m.A.name}</div>
                            <div class="total-score">${sc.At}</div>
                            <div class="indicator-row" style="cursor:pointer">
                                <div class="indicator-label">TO</div>
                                <div class="indicator-ctrl">
                                    <button onclick="Act.timeout('A', -1)" class="btn btn-sq text-muted">${Icons.Minus}</button>
                                    <div class="dots-container px-1">${Indicators('A', m.timeouts.A, 'active-blue')}</div>
                                    <button onclick="Act.timeout('A', 1)" class="btn btn-sq text-white">${Icons.Plus}</button>
                                </div>
                            </div>
                            <div class="indicator-row">
                                <div class="indicator-label">TF</div>
                                <div class="dots-container">${Indicators('A', tf.A, 'active-red')}</div>
                            </div>
                        </div>

                        <div class="period-board">
                            <div onclick="Act.setPeriod(${m.period+1})" class="period-control hover:text-white">Q${m.period} ▶</div>
                            <div class="period-grid">
                                ${PeriodRows()}
                            </div>
                        </div>

                        <!-- AWAY -->
                        <div class="team-display right away-color">
                            <div class="team-name-lg truncate">${m.B.name}</div>
                            <div class="total-score">${sc.Bt}</div>
                            <div class="indicator-row" style="flex-direction:row-reverse">
                                <div class="indicator-label">TO</div>
                                <div class="indicator-ctrl">
                                    <button onclick="Act.timeout('B', -1)" class="btn btn-sq text-muted">${Icons.Minus}</button>
                                    <div class="dots-container px-1">${Indicators('B', m.timeouts.B, 'active-blue')}</div>
                                    <button onclick="Act.timeout('B', 1)" class="btn btn-sq text-white">${Icons.Plus}</button>
                                </div>
                            </div>
                            <div class="indicator-row" style="flex-direction:row-reverse">
                                <div class="indicator-label">TF</div>
                                <div class="dots-container">${Indicators('B', tf.B, 'active-red')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 5-COL COCKPIT -->
                    <div class="cockpit-grid">
                        <div class="col-panel ${State.mobileTab==='LEFT'?'mobile-active':''}"><div class="col-header">ホーム ログ</div><div class="custom-scrollbar grow">${Logs('A')}</div></div>
                        <div class="col-panel ${State.mobileTab==='LEFT'?'mobile-active':''}"><div class="col-header">ホーム メンバー</div><div class="custom-scrollbar grow flex flex-col">${Roster('A')}</div></div>

                        <div class="action-area ${State.mobileTab==='CENTER'?'mobile-active':''}">
                            <div class="target-bar">
                                ${t.side ? `<div class="target-badge" style="background:${t.side==='A'?'var(--primary)':'var(--secondary)'}">${t.id?m[t.side].players.find(p=>p.id===t.id).name:m[t.side].name}</div>` : `<span class="text-muted text-xs tracking-widest opacity-50">選手を選択してください</span>`}
                            </div>
                            <div class="action-buttons">
                                <!-- Row 1 -->
                                <button onclick="Act.stat('3PM')" class="act-btn make"><span>3P</span><span>成功</span></button>
                                <button onclick="Act.stat('3PX')" class="act-btn miss"><span>3P</span><span>失敗</span></button>
                                <!-- Row 2 -->
                                <button onclick="Act.stat('2PM')" class="act-btn make"><span>2P</span><span>成功</span></button>
                                <button onclick="Act.stat('2PX')" class="act-btn miss"><span>2P</span><span>失敗</span></button>
                                <!-- Row 3 -->
                                <button onclick="Act.stat('FTM')" class="act-btn make"><span>FT</span><span>成功</span></button>
                                <button onclick="Act.stat('FTX')" class="act-btn miss"><span>FT</span><span>失敗</span></button>
                                <!-- Row 4 -->
                                <button onclick="Act.stat('ORB')" class="act-btn hover:bg-white/5"><span>ORB</span><span>オフェンス</span></button>
                                <button onclick="Act.stat('DRB')" class="act-btn hover:bg-white/5"><span>DRB</span><span>ディフェンス</span></button>
                                <!-- Row 5 -->
                                <button onclick="Act.stat('AST')" class="act-btn hover:bg-white/5"><span>AST</span><span>アシスト</span></button>
                                <button onclick="Act.stat('TOV')" class="act-btn hover:bg-white/5"><span>TOV</span><span>ミス</span></button>
                                <!-- Row 6 -->
                                <button onclick="Act.stat('PF')" class="act-btn hover:bg-white/5" style="border-color:var(--accent); color:var(--accent)"><span>FOUL</span><span>ファウル</span></button>
                                <button onclick="Act.openSub()" class="act-btn text-muted hover:bg-white/5"><span>SUB</span><span>交代</span></button>
                            </div>
                            <div class="flex p-2 gap-2 border-t border-[#333] bg-panel">
                                <button onclick="Act.undo()" class="btn grow text-muted hover:text-white">${Icons.Undo} 戻す</button>
                                <button onclick="Act.openStats()" class="btn grow text-muted hover:text-white">${Icons.List} 詳細</button>
                                <button onclick="Act.openEnd()" class="btn grow text-muted hover:text-white">${Icons.Exit} 終了</button>
                            </div>
                        </div>

                        <div class="col-panel ${State.mobileTab==='RIGHT'?'mobile-active':''}"><div class="col-header">アウェイ メンバー</div><div class="custom-scrollbar grow flex flex-col">${Roster('B')}</div></div>
                        <div class="col-panel ${State.mobileTab==='RIGHT'?'mobile-active':''}"><div class="col-header">アウェイ ログ</div><div class="custom-scrollbar grow">${Logs('B')}</div></div>
                    </div>

                    <div class="mobile-tabs">
                        <div onclick="State.mobileTab='LEFT';Render()" class="tab-btn ${State.mobileTab==='LEFT'?'active':''}">ホーム</div>
                        <div onclick="State.mobileTab='CENTER';Render()" class="tab-btn ${State.mobileTab==='CENTER'?'active':''}">入力</div>
                        <div onclick="State.mobileTab='RIGHT';Render()" class="tab-btn ${State.mobileTab==='RIGHT'?'active':''}">アウェイ</div>
                    </div>
                </div>
            `;
        };

        // Init
        load();
        window.addEventListener('resize', Render);
        Render();
    </script>
</body>
</html>


