<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Basketball Stats Pro v7.3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        panel: '#121212',
                        card: '#1e1e1e',
                        primary: '#3b82f6',
                        secondary: '#ef4444',
                        accent: '#eab308',
                        success: '#22c55e'
                    },
                    fontFamily: {
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Noto Sans JP', 'sans-serif']
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Core System --- */
        :root { --border: 1px solid #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: #000; color: #fff; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; user-select: none; -webkit-user-select: none; }

        /* Scrollbar */
        .custom-scrollbar { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #444 transparent; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .horizontal-scroll { overflow-x: auto; display: flex; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }

        /* Components */
        .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: 0.1s; font-weight: 600; }
        .btn:active { transform: scale(0.96); filter: brightness(1.2); }
        .num-cell { font-family: monospace; text-align: right; }
        .icon { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }

        /* --- Action Buttons --- */
        .act-btn {
            background: linear-gradient(180deg, #2a2a2a, #202020);
            border: 1px solid #333; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 #111; position: relative;
        }
        .act-btn:active { transform: translateY(4px); box-shadow: none; }
        .act-btn.make { border-color: #22c55e; color: #22c55e; }
        .act-btn.miss { border-color: #ef4444; color: #ef4444; }

        /* --- Layout Logic --- */
        
        /* Default (Portrait) Styles */
        .portrait-layout { display: flex; flex-direction: column; height: 100%; }
        .landscape-layout { display: none; }
        
        .p-roster-row {
            height: 70px; display: flex; align-items: center; gap: 8px; padding: 0 12px;
            background: #111; border-top: 1px solid #333; border-bottom: 1px solid #333;
        }
        .p-player-card {
            min-width: 60px; height: 56px; border-radius: 6px; background: #222; border: 1px solid #444;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: all 0.1s;
        }
        .p-player-card.active { transform: scale(1.05); z-index: 10; border-width: 2px; border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        
        /* Landscape Override */
        @media (orientation: landscape) {
            .portrait-layout { display: none; }
            .landscape-layout { display: grid; height: 100%; grid-template-rows: auto 1fr; }
            
            /* Cockpit Grid */
            .cockpit-grid {
                display: grid;
                grid-template-columns: 200px 220px 1fr 220px 200px; /* 5 Columns */
                height: 100%; overflow: hidden; background: #000;
            }
            /* Smaller landscape (phones) */
            @media (max-height: 600px) {
                .cockpit-grid { grid-template-columns: 1fr 1.4fr 2fr 1.4fr 1fr; }
            }
        }
    </style>
</head>
<body>
    <div id="root" class="w-full h-full"></div>

    <script>
        // --- Utils & Icons ---
        const $ = (s) => document.querySelector(s);
        const genId = () => Math.random().toString(36).substr(2, 9);
        const nowTime = () => new Date().toTimeString().slice(0,5);
        const today = () => new Date().toISOString().split('T')[0];
        const pct = (m, a) => a > 0 ? Math.round((m/a)*100) : 0;
        
        const Icons = {
            Undo: `<svg class="icon"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>`,
            Trash: `<svg class="icon"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
            List: `<svg class="icon"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
            Download: `<svg class="icon"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
            Exit: `<svg class="icon"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
            Plus: `<svg class="icon"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`
        };

        // --- State ---
        const State = {
            view: 'SETUP', 
            teams: [],
            history: [],
            editTeamId: null,
            viewHistoryId: null,
            match: null, 
            target: { side: null, id: null }, // {side: 'A', id: 'xxx'}
            modals: { sub: false, stats: false, end: false, log: false }
        };

        // --- Core Logic (Data & Actions) ---
        const load = () => {
            try {
                const dt = localStorage.getItem('bst_v7_data');
                const dh = localStorage.getItem('bst_v7_history');
                State.teams = dt ? JSON.parse(dt) : [
                    {id:genId(), name:'HOME TEAM', players:genPlayers()},
                    {id:genId(), name:'AWAY TEAM', players:genPlayers()}
                ];
                State.history = dh ? JSON.parse(dh) : [];
            } catch (e) { console.error(e); }
        };
        const saveTeams = () => localStorage.setItem('bst_v7_data', JSON.stringify(State.teams));
        const saveHistory = () => localStorage.setItem('bst_v7_history', JSON.stringify(State.history));
        const genPlayers = () => Array.from({length:5}, (_,i)=>({id:genId(), name:`Player ${4+i}`, number:`${4+i}`})).concat([{id:genId(), name:'Bench 10', number:'10'}, {id:genId(), name:'Bench 11', number:'11'}]);

        const Act = {
            setView: (v) => { State.view = v; Render(); },
            
            // Team Management
            createTeam: () => { State.teams.push({id:genId(), name:'New Team', players:genPlayers()}); saveTeams(); Act.editTeam(State.teams[State.teams.length-1].id); },
            editTeam: (id) => { State.editTeamId = id; State.view = 'EDIT_TEAM'; Render(); },
            deleteTeam: (id) => { if(confirm('Delete Team?')) { State.teams=State.teams.filter(t=>t.id!==id); saveTeams(); Render(); } },
            updateTeamName: (val) => { State.teams.find(t=>t.id===State.editTeamId).name = val; saveTeams(); },
            addPlayer: () => { State.teams.find(t=>t.id===State.editTeamId).players.push({id:genId(), name:'New', number:''}); saveTeams(); Render(); },
            removePlayer: (pid) => { const t=State.teams.find(t=>t.id===State.editTeamId); t.players=t.players.filter(p=>p.id!==pid); saveTeams(); Render(); },
            updatePlayer: (pid, k, v) => { const p=State.teams.find(t=>t.id===State.editTeamId).players.find(p=>p.id===pid); if(p){p[k]=v; saveTeams();} },

            // Match Setup
            start: () => {
                const hid = $('#sel-home').value;
                const aid = $('#sel-away').value;
                const h = State.teams.find(t=>t.id===hid);
                const a = State.teams.find(t=>t.id===aid);
                State.match = {
                    id: genId(), info: { date:$('#inp-date').value, title:$('#inp-title').value },
                    A: { ...h, players: h.players.map(p=>({...p, isOnCourt:true, stats:initStats()})) },
                    B: { ...a, players: a.players.map(p=>({...p, isOnCourt:true, stats:initStats()})) },
                    log: [], history: [], period: 1, timeouts: { A: 0, B: 0 } 
                };
                // Init starters (first 5)
                State.match.A.players.forEach((p,i)=>p.isOnCourt=i<5);
                State.match.B.players.forEach((p,i)=>p.isOnCourt=i<5);
                State.view = 'GAME'; State.target = {side:null,id:null};
                Object.keys(State.modals).forEach(k=>State.modals[k]=false);
                Render();
            },

            // In-Game
            sel: (s, id) => { State.target = (State.target.id === id) ? {side:null, id:null} : {side:s, id:id}; Render(); },
            
            stat: (k) => {
                if(!State.target.side) return alert('Select a player first');
                const m = State.match;
                m.history.push(JSON.stringify({A:m.A, B:m.B, log:m.log, period:m.period, timeouts:m.timeouts}));
                
                const s = State.target.side;
                const pl = m[s].players.find(p => p.id === State.target.id);
                const st = pl ? pl.stats : null;
                let pts = 0;
                
                if (k.includes('3PM')) { pts=3; if(st){st.fgm++; st.fga++; st.tpm++; st.tpa++;} }
                else if (k.includes('3PX')) { if(st){st.fga++; st.tpa++;} }
                else if (k.includes('2PM')) { pts=2; if(st){st.fgm++; st.fga++;} }
                else if (k.includes('2PX')) { if(st){st.fga++;} }
                else if (k.includes('FTM')) { pts=1; if(st){st.ftm++; st.fta++;} }
                else if (k.includes('FTX')) { if(st){st.fta++;} }
                else if (k==='ORB') { if(st) st.orb++; }
                else if (k==='DRB') { if(st) st.drb++; }
                else if (k==='AST') { if(st) st.ast++; }
                else if (k==='TOV') { if(st) st.tov++; }
                else if (k==='PF') { if(st) st.pf++; }
                
                if(pts > 0 && st) st.pts += pts;
                m.log.unshift({ id: genId(), time: nowTime(), period: m.period, side: s, pts: pts, txt: `${pl?`#${pl.number}`:m[s].name} ${k}` });
                
                // Clear selection if desired? No, keep for combos.
                Render();
            },

            undo: () => {
                if(State.match.history.length) {
                    const p = JSON.parse(State.match.history.pop());
                    Object.assign(State.match, {A:p.A, B:p.B, log:p.log, period:p.period, timeouts:p.timeouts});
                    Render();
                }
            },
            
            period: (delta) => { 
                State.match.period += delta; 
                if(State.match.period<1) State.match.period=1;
                Render(); 
            },

            sub: (side, outId, inId) => {
                const t = State.match[side];
                t.players.find(p=>p.id===outId).isOnCourt = false;
                t.players.find(p=>p.id===inId).isOnCourt = true;
                State.match.log.unshift({time:nowTime(), period:State.match.period, side:side, txt:`SUB: #${t.players.find(p=>p.id===inId).number} IN`});
                State.modals.sub = false; window.subOut=null; window.subIn=null;
                Render();
            },

            finish: (save) => {
                if(save) {
                    const sc = calcScores(State.match);
                    State.history.unshift({ ...State.match, history:[], finalScore: { A: sc.At, B: sc.Bt } });
                    saveHistory();
                }
                State.match = null; State.view = 'SETUP'; Render();
            },
            
            exportAll: () => {
                const csv = State.history.map(m => generateMatchCSV(m)).join("\n\n");
                const el = document.createElement("textarea"); el.value = csv; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert('Copied CSV to clipboard');
            },
            
            delHist: (id) => { if(confirm('Delete?')) { State.history=State.history.filter(h=>h.id!==id); saveHistory(); Render(); } }
        };

        const initStats = () => ({pts:0, fgm:0, fga:0, tpm:0, tpa:0, ftm:0, fta:0, orb:0, drb:0, ast:0, tov:0, pf:0});
        const calcScores = (m) => {
            const sc = {A:[0,0,0,0,0], B:[0,0,0,0,0], At:0, Bt:0}; 
            m.log.forEach(l => { if(l.pts) { sc[l.side][Math.min(l.period-1,4)] += l.pts; sc[l.side+'t'] += l.pts; } });
            return sc;
        };
        const generateMatchCSV = (m) => {
            let csv = `DATE,${m.info.date}\nTITLE,${m.info.title}\n`;
            ['A', 'B'].forEach(s => {
                csv += `TEAM,${m[s].name}\nNo,Name,PTS,REB,AST,PF,FG,3P,FT\n`;
                m[s].players.forEach(p => { const st=p.stats; if(st.pts+st.fga+st.pf>0) csv+=`${p.number},${p.name},${st.pts},${st.orb+st.drb},${st.ast},${st.pf},${st.fgm}/${st.fga},${st.tpm}/${st.tpa},${st.ftm}/${st.fta}\n`; });
            });
            return csv;
        };

        // --- Render Views ---
        const Render = () => {
            const root = $('#root');
            if(State.view === 'SETUP') return root.innerHTML = SetupView();
            if(State.view === 'EDIT_TEAM') return root.innerHTML = TeamEditView();
            if(State.view === 'GAME') return root.innerHTML = GameView();
        };

        const SetupView = () => `
            <div class="h-full flex items-center justify-center p-6 bg-black">
                <div class="w-full max-w-md bg-panel border border-[#333] rounded-xl p-6 shadow-2xl">
                    <h1 class="text-3xl font-black mb-8 text-center text-white italic tracking-tighter">BASKETBALL <span class="text-primary">STATS PRO</span></h1>
                    <div class="space-y-4 mb-8">
                        <div><label class="text-xs text-gray-500 font-bold">INFO</label><div class="flex gap-2"><input id="inp-date" type="date" value="${today()}" class="bg-black border border-[#333] rounded p-2 flex-1"><input id="inp-title" value="Game" class="bg-black border border-[#333] rounded p-2 flex-[2]"></div></div>
                        <div>
                            <label class="text-xs text-gray-500 font-bold">MATCHUP</label>
                            <div class="flex gap-2 items-center">
                                <select id="sel-home" class="bg-black border border-[#333] rounded p-3 flex-1 text-primary font-bold">${State.teams.map(t=>`<option value="${t.id}">${t.name}</option>`)}</select>
                                <span class="text-gray-600 font-black">VS</span>
                                <select id="sel-away" class="bg-black border border-[#333] rounded p-3 flex-1 text-secondary font-bold">${State.teams.map(t=>`<option value="${t.id}">${t.name}</option>`)}</select>
                            </div>
                        </div>
                    </div>
                    <button onclick="Act.start()" class="btn w-full p-4 bg-primary text-white text-lg font-bold mb-4 shadow-lg shadow-blue-900/30">START GAME</button>
                    <div class="grid grid-cols-2 gap-3 border-t border-[#333] pt-6">
                        <button onclick="Act.createTeam()" class="btn py-3 bg-card text-gray-400 hover:bg-[#222]">TEAMS</button>
                        <button onclick="Act.exportAll()" class="btn py-3 bg-card text-gray-400 hover:bg-[#222]">HISTORY</button>
                    </div>
                    ${State.history.length>0 ? `<div class="mt-4 max-h-32 overflow-y-auto border-t border-[#333] pt-2">${State.history.map(h=>`<div class="flex justify-between text-xs text-gray-500 py-1"><span>${h.info.date} ${h.info.title}</span><span onclick="Act.delHist('${h.id}')" class="cursor-pointer text-red-500">x</span></div>`).join('')}</div>` : ''}
                </div>
            </div>
        `;

        const TeamEditView = () => {
            const t = State.teams.find(x => x.id === State.editTeamId);
            return `
            <div class="flex flex-col h-full bg-panel">
                <div class="p-4 border-b border-[#333] flex justify-between items-center bg-black sticky top-0 z-10">
                    <h2 class="font-bold">EDIT TEAM</h2>
                    <button onclick="Act.setView('SETUP')" class="btn px-4 py-1 bg-success text-black font-bold text-sm">DONE</button>
                </div>
                <div class="p-4 flex-1 overflow-hidden flex flex-col max-w-2xl mx-auto w-full">
                    <div class="mb-4">
                        <label class="text-xs text-gray-500">TEAM NAME</label>
                        <input value="${t.name}" oninput="Act.updateTeamName(this.value)" class="text-lg font-bold mt-1 bg-black border border-[#333] rounded p-2 w-full focus:border-primary">
                    </div>
                    <div class="flex justify-between items-center mb-2 mt-2">
                        <span class="text-xs text-gray-500 font-bold">ROSTER</span>
                        <button onclick="Act.addPlayer()" class="btn px-3 py-1 text-xs bg-white/10 hover:bg-white/20">${Icons.Plus} ADD</button>
                    </div>
                    <div class="custom-scrollbar flex-1 -mx-2 px-2">
                        ${t.players.map(p => `
                            <div class="flex items-center gap-2 mb-2 bg-card p-2 rounded border border-[#333]">
                                <input value="${p.number}" placeholder="#" onchange="Act.updatePlayer('${p.id}','number',this.value)" class="w-12 text-center font-mono font-bold bg-black border border-[#444] rounded p-1 focus:border-primary">
                                <input value="${p.name}" placeholder="Name" onchange="Act.updatePlayer('${p.id}','name',this.value)" class="flex-1 bg-transparent border-none focus:bg-black focus:border-b p-1">
                                <button onclick="Act.removePlayer('${p.id}')" class="btn text-gray-500 hover:text-red-500 p-2">${Icons.Trash}</button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="Act.deleteTeam('${t.id}');Act.setView('SETUP')" class="mt-4 btn w-full p-3 border border-red-900/50 text-red-500 hover:bg-red-900/10">DELETE TEAM</button>
                </div>
            </div>
            `;
        };

        const GameView = () => {
            const m = State.match;
            const t = State.target;
            const sc = calcScores(m);
            const activeP = t.id ? (m.A.players.find(p=>p.id===t.id) || m.B.players.find(p=>p.id===t.id)) : null;

            // --- Components ---
            const ActionGrid = `
                <div class="grid grid-cols-4 grid-rows-3 gap-2 h-full">
                    <button onclick="Act.stat('3PM')" class="act-btn make col-span-1 row-span-1"><span class="text-xl font-black italic">3P</span><span class="text-[9px]">MAKE</span></button>
                    <button onclick="Act.stat('2PM')" class="act-btn make col-span-1 row-span-1"><span class="text-xl font-black italic">2P</span><span class="text-[9px]">MAKE</span></button>
                    <button onclick="Act.stat('FTM')" class="act-btn make col-span-1 row-span-1"><span class="text-lg font-black">FT</span><span class="text-[9px]">MAKE</span></button>
                    <button onclick="Act.stat('ORB')" class="act-btn text-gray-300 hover:bg-[#333]"><span class="text-lg font-bold">ORB</span></button>

                    <button onclick="Act.stat('3PX')" class="act-btn miss col-span-1 row-span-1"><span class="text-xl font-black italic text-gray-500">3P</span><span class="text-[9px] text-gray-500">MISS</span></button>
                    <button onclick="Act.stat('2PX')" class="act-btn miss col-span-1 row-span-1"><span class="text-xl font-black italic text-gray-500">2P</span><span class="text-[9px] text-gray-500">MISS</span></button>
                    <button onclick="Act.stat('FTX')" class="act-btn miss col-span-1 row-span-1"><span class="text-lg font-black text-gray-500">FT</span><span class="text-[9px] text-gray-500">MISS</span></button>
                    <button onclick="Act.stat('DRB')" class="act-btn text-gray-300 hover:bg-[#333]"><span class="text-lg font-bold">DRB</span></button>

                    <button onclick="Act.stat('AST')" class="act-btn text-accent hover:bg-[#333] border-accent/30"><span class="text-lg font-bold">AST</span></button>
                    <button onclick="Act.stat('TOV')" class="act-btn text-gray-400 hover:bg-[#333]"><span class="text-lg font-bold">TO</span></button>
                    <button onclick="Act.stat('PF')" class="act-btn text-red-500 hover:bg-[#333] border-red-900/50"><span class="text-lg font-bold">PF</span></button>
                    <button onclick="State.modals.sub=true;Render()" class="act-btn text-gray-500 hover:bg-[#333] border-gray-800"><span class="text-lg font-bold">SUB</span></button>
                </div>
            `;
            
            const Controls = `
                 <div class="flex gap-1 h-full">
                    <button onclick="Act.undo()" class="btn flex-1 bg-card hover:bg-white/10 text-gray-400">${Icons.Undo}</button>
                    <button onclick="State.modals.stats=true;Render()" class="btn flex-1 bg-card hover:bg-white/10 text-gray-400">STATS</button>
                    <button onclick="State.modals.log=true;Render()" class="btn flex-1 bg-card hover:bg-white/10 text-gray-400">LOG</button>
                    <button onclick="State.modals.end=true;Render()" class="btn flex-1 bg-card hover:bg-white/10 text-red-800">${Icons.Exit}</button>
                </div>
            `;

            // Horizontal Roster (Portrait)
            const PRoster = (side) => {
                const tm = m[side];
                return `<div class="horizontal-scroll gap-2 p-2 h-full items-center bg-[#111] border-b border-[#333] ${side==='A'?'border-t border-[#333]':''}">
                    <div class="flex-shrink-0 w-8 flex items-center justify-center font-bold text-xs ${side==='A'?'text-primary':'text-secondary'} writing-mode-vertical" style="writing-mode: vertical-rl;">${side==='A'?'HOME':'AWAY'}</div>
                    ${tm.players.filter(p=>p.isOnCourt).map(p=>`
                        <div onclick="Act.sel('${side}','${p.id}')" class="p-player-card ${t.id===p.id?'active bg-'+(side==='A'?'primary':'secondary'):''}">
                            <div class="font-mono font-bold text-lg leading-none">${p.number}</div>
                            <div class="text-[9px] truncate w-14 text-center text-gray-400 leading-tight">${p.name}</div>
                            ${p.stats.pf>0 ? `<div class="absolute top-0 right-0 w-2 h-2 rounded-full ${p.stats.pf>=4?'bg-red-500':'bg-yellow-500'}"></div>`:''}
                        </div>
                    `).join('')}
                    <button onclick="State.target.side='${side}';State.modals.sub=true;Render()" class="p-player-card border-dashed opacity-50"><span class="text-[10px]">SUB</span></button>
                </div>`;
            };

            // Vertical Roster (Landscape)
            const LRoster = (side) => {
                const tm = m[side];
                return tm.players.filter(p=>p.isOnCourt).map(p => `
                    <div onclick="Act.sel('${side}','${p.id}')" class="p-2 border-b border-[#333] flex items-center gap-2 cursor-pointer ${t.id===p.id? (side==='A'?'bg-primary':'bg-secondary') : 'hover:bg-[#222]'}">
                        <div class="font-mono font-bold w-6 text-center text-gray-400">${p.number}</div>
                        <div class="flex-1 font-bold text-xs truncate">${p.name}</div>
                        <div class="text-[10px] font-mono text-gray-500">P:${p.stats.pts} F:${p.stats.pf}</div>
                    </div>
                `).join('');
            };

            // Modals
            const SubModal = () => {
                if(!State.modals.sub) return '';
                const s = t.side || 'A';
                const tm = m[s];
                return `<div class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4" onclick="if(event.target===this){State.modals.sub=false;Render()}">
                    <div class="bg-card w-full max-w-sm rounded-lg border border-[#444] flex flex-col max-h-[80vh]">
                        <div class="p-3 border-b border-[#333] font-bold text-center ${s==='A'?'text-primary':'text-secondary'}">SUBSTITUTION: ${tm.name}</div>
                        <div class="flex-1 overflow-y-auto p-2">
                            <div class="text-xs text-center mb-1 text-red-400">OUT (ON COURT)</div>
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                ${tm.players.filter(p=>p.isOnCourt).map(p=>`<button onclick="window.subOut='${p.id}';this.style.borderColor='red'" class="btn border border-[#333] p-2 bg-black justify-between"><span class="font-mono text-lg">${p.number}</span><span class="text-xs truncate ml-2">${p.name}</span></button>`).join('')}
                            </div>
                            <div class="text-xs text-center mb-1 text-blue-400">IN (BENCH)</div>
                            <div class="grid grid-cols-2 gap-2">
                                ${tm.players.filter(p=>!p.isOnCourt).map(p=>`<button onclick="window.subIn='${p.id}';this.style.borderColor='#3b82f6'" class="btn border border-[#333] p-2 bg-black justify-between"><span class="font-mono text-lg">${p.number}</span><span class="text-xs truncate ml-2">${p.name}</span></button>`).join('')}
                            </div>
                        </div>
                        <button onclick="if(window.subOut&&window.subIn)Act.sub('${s}',window.subOut,window.subIn)" class="p-4 bg-white text-black font-bold m-2 rounded">CONFIRM</button>
                    </div>
                </div>`;
            };

            const LogModal = () => !State.modals.log ? '' : `<div class="fixed inset-0 z-50 bg-black/90 flex flex-col p-4 animate-fade-in"><div class="flex justify-between items-center mb-4"><h2 class="font-bold">GAME LOG</h2><button onclick="State.modals.log=false;Render()" class="btn px-4 bg-[#333]">CLOSE</button></div><div class="flex-1 overflow-y-auto custom-scrollbar">${m.log.map(l=>`<div class="border-b border-[#222] py-2 flex gap-2 text-xs"><span class="font-mono text-gray-500">${l.time}</span><span class="font-bold ${l.side==='A'?'text-primary':'text-secondary'}">${l.side}</span> <span class="flex-1">${l.txt}</span> ${l.pts?`<span class="text-white font-bold">+${l.pts}</span>`:''}</div>`).join('')}</div></div>`;
            
            const StatsModal = () => {
                 if(!State.modals.stats) return '';
                 const renderTable = (s) => `<div class="mb-6"><div class="font-bold mb-2 ${s==='A'?'text-primary':'text-secondary'}">${m[s].name}</div><table class="w-full text-xs text-left"><thead><tr class="text-gray-500 border-b border-[#333]"><th>#</th><th>PTS</th><th>REB</th><th>AST</th><th>PF</th></tr></thead><tbody>${m[s].players.map(p=>`<tr class="border-b border-[#222]"><td class="py-2 font-mono text-gray-500">${p.number}</td><td class="font-bold text-white">${p.stats.pts}</td><td>${p.stats.orb+p.stats.drb}</td><td>${p.stats.ast}</td><td>${p.stats.pf}</td></tr>`).join('')}</tbody></table></div>`;
                 return `<div class="fixed inset-0 z-50 bg-black/90 flex flex-col p-6"><div class="flex justify-between mb-4"><h2 class="font-bold">BOX SCORE</h2><button onclick="State.modals.stats=false;Render()" class="btn px-4 bg-[#333]">CLOSE</button></div><div class="flex-1 overflow-y-auto">${renderTable('A')}${renderTable('B')}</div></div>`;
            };

            const EndModal = () => !State.modals.end ? '' : `<div class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur"><div class="bg-card border border-[#333] p-6 rounded-lg w-80 text-center shadow-2xl"><h3 class="font-bold text-xl mb-4 text-white">FINISH GAME?</h3><button onclick="Act.finish(true)" class="btn w-full p-3 bg-primary text-white font-bold mb-2">SAVE & EXIT</button><button onclick="State.modals.end=false;Render()" class="btn w-full p-3 text-gray-500">CANCEL</button></div></div>`;

            // --- Layout Rendering ---
            return `
                ${SubModal()}${LogModal()}${StatsModal()}${EndModal()}
                
                <!-- PORTRAIT LAYOUT (Vertical Stack) -->
                <div class="portrait-layout">
                    <!-- 1. Scoreboard (Compact) -->
                    <div class="flex items-center justify-between px-4 py-2 bg-panel border-b border-[#333] h-14">
                        <div class="text-2xl font-black text-primary font-mono">${sc.At}</div>
                        <div class="flex flex-col items-center cursor-pointer" onclick="Act.period(1)">
                            <div class="text-xs text-gray-500">Q${m.period}</div>
                            <div class="text-[10px] text-gray-600 font-mono">${nowTime()}</div>
                        </div>
                        <div class="text-2xl font-black text-secondary font-mono">${sc.Bt}</div>
                    </div>
                    
                    <!-- 2. Home Roster -->
                    <div class="h-20 bg-black">${PRoster('A')}</div>

                    <!-- 3. Action Area (Middle) -->
                    <div class="flex-1 flex flex-col bg-black min-h-0">
                        <!-- Info Bar -->
                        <div class="h-8 flex items-center justify-center border-b border-[#333] bg-[#1a1a1a]">
                            ${activeP ? `<span class="px-3 py-0.5 rounded text-xs font-bold ${t.side==='A'?'bg-primary text-white':'bg-secondary text-white'}">#${activeP.number} ${activeP.name}</span>` : `<span class="text-[10px] text-gray-600 tracking-widest">SELECT PLAYER</span>`}
                            ${m.log.length>0 ? `<span class="absolute right-2 text-[9px] text-gray-500 truncate max-w-[120px]">${m.log[0].txt}</span>`:''}
                        </div>
                        <!-- Grid -->
                        <div class="flex-1 p-2">${ActionGrid}</div>
                        <!-- Bottom Controls -->
                        <div class="h-12 p-2 border-t border-[#333]">${Controls}</div>
                    </div>

                    <!-- 4. Away Roster -->
                    <div class="h-20 bg-black">${PRoster('B')}</div>
                </div>

                <!-- LANDSCAPE LAYOUT (Cockpit) -->
                <div class="landscape-layout">
                    <!-- Header -->
                    <div class="bg-panel border-b border-[#333] h-12 flex justify-between items-center px-4">
                        <div class="flex items-center gap-4">
                            <span class="text-primary font-bold">${m.A.name}</span>
                            <span class="text-2xl font-mono font-black">${sc.At} - ${sc.Bt}</span>
                            <span class="text-secondary font-bold">${m.B.name}</span>
                        </div>
                        <div class="flex items-center gap-4">
                             <button onclick="Act.period(1)" class="font-bold text-accent">Q${m.period}</button>
                             <span class="text-xs text-gray-500 font-mono">${nowTime()}</span>
                        </div>
                    </div>
                    
                    <!-- 5 Column Grid -->
                    <div class="cockpit-grid">
                        <div class="border-r border-[#333] flex flex-col"><div class="bg-[#111] text-[10px] text-center text-gray-500 py-1">HOME LOG</div><div class="flex-1 custom-scrollbar bg-panel text-[10px] p-1">${m.log.filter(l=>l.side==='A').map(l=>`<div class="border-b border-[#222] py-1 text-gray-400">${l.time} ${l.txt}</div>`).join('')}</div></div>
                        <div class="border-r border-[#333] flex flex-col"><div class="bg-[#111] text-[10px] text-center text-gray-500 py-1">HOME ROSTER</div><div class="flex-1 custom-scrollbar bg-panel">${LRoster('A')}</div></div>
                        
                        <!-- Center Action -->
                        <div class="flex flex-col bg-black">
                             <div class="h-8 flex items-center justify-center border-b border-[#333] bg-[#1a1a1a]">
                                ${activeP ? `<span class="px-3 py-0.5 rounded text-xs font-bold ${t.side==='A'?'bg-primary text-white':'bg-secondary text-white'}">#${activeP.number} ${activeP.name}</span>` : `<span class="text-[10px] text-gray-600 tracking-widest">SELECT PLAYER</span>`}
                            </div>
                            <div class="flex-1 p-4">${ActionGrid}</div>
                            <div class="h-12 p-2 border-t border-[#333]">${Controls}</div>
                        </div>

                        <div class="border-r border-[#333] flex flex-col"><div class="bg-[#111] text-[10px] text-center text-gray-500 py-1">AWAY ROSTER</div><div class="flex-1 custom-scrollbar bg-panel">${LRoster('B')}</div></div>
                        <div class="flex flex-col"><div class="bg-[#111] text-[10px] text-center text-gray-500 py-1">AWAY LOG</div><div class="flex-1 custom-scrollbar bg-panel text-[10px] p-1">${m.log.filter(l=>l.side==='B').map(l=>`<div class="border-b border-[#222] py-1 text-gray-400">${l.time} ${l.txt}</div>`).join('')}</div></div>
                    </div>
                </div>
            `;
        };

        load();
        window.addEventListener('resize', Render);
        Render();
    </script>
</body>
</html>

