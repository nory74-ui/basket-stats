<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Basketball Stats Pro v8.4</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        panel: '#121212',
                        card: '#1e1e1e',
                        primary: '#3b82f6',
                        secondary: '#ef4444',
                        accent: '#eab308',
                        success: '#22c55e'
                    },
                    fontFamily: {
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Noto Sans JP', 'sans-serif']
                    },
                    spacing: {
                        'safe-t': 'env(safe-area-inset-top)',
                        'safe-b': 'env(safe-area-inset-bottom)',
                        'safe-l': 'env(safe-area-inset-left)',
                        'safe-r': 'env(safe-area-inset-right)',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Core System --- */
        :root { --border: 1px solid #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            background-color: #000; color: #fff; 
            height: 100dvh; width: 100vw; 
            overflow: hidden; 
            display: flex; flex-direction: column; 
            user-select: none; -webkit-user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Scrollbar */
        .custom-scrollbar { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #444 transparent; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .horizontal-scroll { overflow-x: auto; display: flex; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }

        /* Components */
        .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: 0.1s; font-weight: 600; }
        .btn:active { transform: scale(0.96); filter: brightness(1.2); }
        .icon { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }

        /* Action Buttons */
        .act-btn {
            background: linear-gradient(180deg, #2a2a2a, #202020);
            border: 1px solid #333; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 #111; position: relative;
            transition: all 0.1s ease-out;
        }
        .act-btn:active { transform: translateY(4px); box-shadow: none; }
        .act-btn.make { border-color: #22c55e; color: #22c55e; }
        .act-btn.miss { border-color: #ef4444; color: #ef4444; }

        /* Selected States (Inverted Colors) */
        .act-btn.selected {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #000;
        }
        .act-btn.make.selected { background: #22c55e !important; color: black !important; border-color: #22c55e !important; }
        .act-btn.miss.selected { background: #ef4444 !important; color: black !important; border-color: #ef4444 !important; }
        .act-btn:not(.make):not(.miss).selected { background: #e5e5e5 !important; color: black !important; border-color: #e5e5e5 !important; }

        /* --- Portrait Layout --- */
        .portrait-layout { 
            display: flex; flex-direction: column; height: 100%; 
            padding-top: 4px; padding-bottom: 8px; gap: 4px;
        }
        .landscape-layout { display: none; }
        
        .p-player-card {
            min-width: 60px; height: 56px; border-radius: 6px; background: #222; border: 1px solid #444;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: all 0.1s;
        }
        .p-player-card.active { transform: scale(1.05); z-index: 10; border-width: 2px; border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        
        /* --- Landscape Layout --- */
        @media (orientation: landscape) {
            .portrait-layout { display: none; }
            .landscape-layout { display: grid; height: 100%; grid-template-rows: auto 1fr; }
            body { padding: 0; }
            .cockpit-grid {
                display: grid;
                grid-template-columns: 200px 220px 1fr 220px 200px;
                height: 100%; overflow: hidden; background: #000;
            }
            @media (max-height: 600px) {
                .cockpit-grid { grid-template-columns: 1fr 1.4fr 2fr 1.4fr 1fr; }
            }
        }

        /* --- PRINT STYLES --- */
        @media print {
            @page { size: A4; margin: 5mm 10mm; }
            body { 
                background-color: white !important; color: black !important; 
                height: auto !important; overflow: visible !important; 
                padding: 0 !important; display: block !important;
                font-size: 9pt !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
            }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .portrait-layout, .landscape-layout, .setup-view, .history-view { display: none !important; }
            .report-view { 
                display: block !important; height: auto !important; overflow: visible !important;
                background: white !important; color: black !important; padding: 0 !important;
            }
            .report-container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; min-height: 0 !important; }
            .print-header { margin-bottom: 10px !important; }
            .print-title { font-size: 16pt !important; margin-bottom: 5px !important; }
            .print-date { font-size: 9pt !important; color: #555 !important; }
            .print-scoreboard { margin-bottom: 10px !important; padding-bottom: 10px !important; gap: 20px !important; }
            .print-team-name { font-size: 14pt !important; }
            .print-score-val { font-size: 24pt !important; line-height: 1 !important; }
            .print-period-table th, .print-period-table td { padding: 2px 8px !important; font-size: 8pt !important; }
            .print-period-container { margin-bottom: 15px !important; }
            .report-card { border: none !important; box-shadow: none !important; background: white !important; margin-bottom: 10px !important; page-break-inside: avoid; }
            .report-card-title { font-size: 11pt !important; margin-bottom: 4px !important; border-bottom-width: 1px !important; }
            table { width: 100%; border-collapse: collapse; font-size: 8pt !important; }
            th, td { border: 1px solid #ccc !important; padding: 2px 3px !important; color: black !important; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
            .print-text-black { color: black !important; }
            .print-bg-gray { background-color: #f0f0f0 !important; }
            .print-footer { font-size: 7pt !important; margin-top: 10px !important; padding-top: 4px !important; }
        }
    </style>
</head>
<body>
    <div id="root" class="w-full h-full"></div>

    <script>
        // --- Utils & Icons ---
        const $ = (s) => document.querySelector(s);
        const genId = () => Math.random().toString(36).substr(2, 9);
        const nowTime = () => new Date().toTimeString().slice(0,5);
        const today = () => new Date().toISOString().split('T')[0];
        const pct = (m, a) => a > 0 ? Math.round((m/a)*100) : 0;
        
        const Icons = {
            Undo: `<svg class="icon"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>`,
            Trash: `<svg class="icon"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
            List: `<svg class="icon"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
            Exit: `<svg class="icon"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
            Plus: `<svg class="icon"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
            Print: `<svg class="icon"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>`
        };

        // --- State ---
        const State = {
            view: 'SETUP', 
            teams: [], history: [], editTeamId: null, match: null, reportId: null,
            target: { side: null, id: null }, 
            activeAction: null,
            modals: { sub: false, stats: false, end: false, log: false, period: false }
        };

        // --- Logic ---
        const load = () => {
            try {
                const dt = localStorage.getItem('bst_v8_data');
                const dh = localStorage.getItem('bst_v8_history');
                State.teams = dt ? JSON.parse(dt) : [ {id:genId(), name:'HOME TEAM', players:genPlayers()}, {id:genId(), name:'AWAY TEAM', players:genPlayers()} ];
                State.history = dh ? JSON.parse(dh) : [];
            } catch (e) { console.error(e); }
        };
        const saveTeams = () => localStorage.setItem('bst_v8_data', JSON.stringify(State.teams));
        const saveHistory = () => localStorage.setItem('bst_v8_history', JSON.stringify(State.history));
        const genPlayers = () => Array.from({length:5}, (_,i)=>({id:genId(), name:`Player ${4+i}`, number:`${4+i}`})).concat([{id:genId(), name:'Bench 10', number:'10'}, {id:genId(), name:'Bench 11', number:'11'}]);

        // Rules
        const getTOLimit = (p) => (p <= 2) ? 2 : (p <= 4 ? 3 : 1);
        const getTOTaken = (m, side) => {
            const history = m.timeouts[side];
            if (m.period <= 2) return history.filter(x => x <= 2).length;
            if (m.period <= 4) return history.filter(x => x > 2 && x <= 4).length;
            return history.filter(x => x === m.period).length;
        };
        const getTeamFouls = (m, side) => {
            const p = m.period;
            return m.log.filter(l => 
                l.side === side && 
                (l.txt.includes('PF') || l.txt.includes('FOUL')) && 
                (p > 4 ? l.period >= 4 : l.period === p)
            ).length;
        };

        const Act = {
            setView: (v) => { State.view = v; Render(); },
            // Team Mgmt
            createTeam: () => { State.teams.push({id:genId(), name:'New Team', players:genPlayers()}); saveTeams(); Act.editTeam(State.teams[State.teams.length-1].id); },
            editTeam: (id) => { State.editTeamId = id; State.view = 'EDIT_TEAM'; Render(); },
            deleteTeam: (id) => { if(confirm('Delete Team?')) { State.teams=State.teams.filter(t=>t.id!==id); saveTeams(); Render(); } },
            updateTeamName: (val) => { State.teams.find(t=>t.id===State.editTeamId).name = val; saveTeams(); },
            addPlayer: () => { State.teams.find(t=>t.id===State.editTeamId).players.push({id:genId(), name:'New', number:''}); saveTeams(); Render(); },
            removePlayer: (pid) => { const t=State.teams.find(t=>t.id===State.editTeamId); t.players=t.players.filter(p=>p.id!==pid); saveTeams(); Render(); },
            updatePlayer: (pid, k, v) => { const p=State.teams.find(t=>t.id===State.editTeamId).players.find(p=>p.id===pid); if(p){p[k]=v; saveTeams();} },

            // Game
            start: () => {
                const hid = $('#sel-home').value;
                const aid = $('#sel-away').value;
                const h = State.teams.find(t=>t.id===hid);
                const a = State.teams.find(t=>t.id===aid);
                State.match = {
                    id: genId(), info: { date:$('#inp-date').value, title:$('#inp-title').value },
                    A: { ...h, players: h.players.map(p=>({...p, isOnCourt:true, stats:initStats()})) },
                    B: { ...a, players: a.players.map(p=>({...p, isOnCourt:true, stats:initStats()})) },
                    log: [], history: [], period: 1, 
                    timeouts: { A: [], B: [] } 
                };
                State.match.A.players.forEach((p,i)=>p.isOnCourt=i<5);
                State.match.B.players.forEach((p,i)=>p.isOnCourt=i<5);
                State.view = 'GAME'; 
                State.target = {side:null,id:null};
                State.activeAction = null;
                Object.keys(State.modals).forEach(k=>State.modals[k]=false);
                Render();
            },
            
            sel: (s, id) => { 
                State.target = (State.target.id === id) ? {side:null, id:null} : {side:s, id:id}; 
                State.activeAction = null;
                Render(); 
            },
            
            stat: (k) => {
                if(!State.target.side) return alert('Select a player first');
                State.activeAction = k;
                const m = State.match;
                m.history.push(JSON.stringify({A:m.A, B:m.B, log:m.log, period:m.period, timeouts:m.timeouts}));
                const s = State.target.side;
                const pl = m[s].players.find(p => p.id === State.target.id);
                const st = pl ? pl.stats : null;
                let pts = 0;
                
                if (k.includes('3PM')) { pts=3; if(st){st.fgm++; st.fga++; st.tpm++; st.tpa++;} }
                else if (k.includes('3PX')) { if(st){st.fga++; st.tpa++;} }
                else if (k.includes('2PM')) { pts=2; if(st){st.fgm++; st.fga++;} }
                else if (k.includes('2PX')) { if(st){st.fga++;} }
                else if (k.includes('FTM')) { pts=1; if(st){st.ftm++; st.fta++;} }
                else if (k.includes('FTX')) { if(st){st.fta++;} }
                else if (k==='ORB') { if(st) st.orb++; }
                else if (k==='DRB') { if(st) st.drb++; }
                else if (k==='AST') { if(st) st.ast++; }
                else if (k==='TOV') { if(st) st.tov++; }
                else if (k==='PF') { if(st) st.pf++; }
                
                if(pts > 0 && st) st.pts += pts;
                m.log.unshift({ id: genId(), time: nowTime(), period: m.period, side: s, pts: pts, txt: `${pl?`#${pl.number}`:m[s].name} ${k}` });
                Render();
            },

            undo: () => { 
                if(State.match.history.length) { 
                    const p = JSON.parse(State.match.history.pop()); 
                    Object.assign(State.match, {A:p.A, B:p.B, log:p.log, period:p.period, timeouts:p.timeouts}); 
                    State.activeAction = null;
                    Render(); 
                } 
            },
            setPeriod: (p) => { State.match.period = p; State.modals.period = false; Render(); },
            timeout: (side) => {
                const m = State.match;
                if (getTOTaken(m, side) >= getTOLimit(m.period)) return;
                m.history.push(JSON.stringify({A:m.A, B:m.B, log:m.log, period:m.period, timeouts:m.timeouts}));
                m.timeouts[side].push(m.period);
                m.log.unshift({ id: genId(), time: nowTime(), period: m.period, side: side, txt: 'TIMEOUT' });
                Render();
            },
            sub: (s, o, i) => { const t = State.match[s]; t.players.find(p=>p.id===o).isOnCourt=false; t.players.find(p=>p.id===i).isOnCourt=true; State.match.log.unshift({time:nowTime(), period:State.match.period, side:s, txt:`SUB: #${t.players.find(p=>p.id===i).number} IN`}); State.modals.sub=false; window.subOut=null; window.subIn=null; Render(); },
            finish: (s) => { if(s) { const sc = calcScores(State.match); State.history.unshift({ ...State.match, history:[], finalScore: { A: sc.At, B: sc.Bt } }); saveHistory(); } State.match=null; State.view='SETUP'; Render(); },
            
            // Report
            viewReport: (id) => { State.reportId = id; Act.setView('REPORT'); },
            printReport: () => { window.print(); },
            delHist: (id) => { if(confirm('Delete?')) { State.history=State.history.filter(h=>h.id!==id); saveHistory(); Render(); } }
        };

        const initStats = () => ({pts:0, fgm:0, fga:0, tpm:0, tpa:0, ftm:0, fta:0, orb:0, drb:0, ast:0, tov:0, pf:0});
        const calcScores = (m) => { const sc = {A:[0,0,0,0,0], B:[0,0,0,0,0], At:0, Bt:0}; m.log.forEach(l => { if(l.pts) { sc[l.side][Math.min(l.period-1,4)] += l.pts; sc[l.side+'t'] += l.pts; } }); return sc; };

        // --- Views ---
        const Render = () => {
            const root = $('#root');
            if(State.view === 'SETUP') return root.innerHTML = SetupView();
            if(State.view === 'HISTORY') return root.innerHTML = HistoryListView();
            if(State.view === 'REPORT') return root.innerHTML = ReportView();
            if(State.view === 'EDIT_TEAM') return root.innerHTML = TeamEditView();
            if(State.view === 'GAME') return root.innerHTML = GameView();
        };

        const SetupView = () => `
            <div class="setup-view h-full flex items-center justify-center p-6 bg-black">
                <div class="w-full max-w-md bg-panel border border-[#333] rounded-xl p-6 shadow-2xl">
                    <h1 class="text-3xl font-black mb-8 text-center text-white italic tracking-tighter">BASKETBALL <span class="text-primary">STATS PRO</span></h1>
                    <div class="space-y-4 mb-8">
                        <div>
                            <label class="text-xs text-gray-500 font-bold">INFO</label>
                            <div class="flex flex-col gap-2 mt-1">
                                <input id="inp-date" type="date" value="${today()}" class="bg-black border border-[#333] rounded p-2 w-full">
                                <input id="inp-title" value="Game" placeholder="Match Title" class="bg-black border border-[#333] rounded p-2 w-full">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 font-bold">MATCHUP</label>
                            <div class="flex gap-2 items-center mt-1">
                                <select id="sel-home" class="bg-black border border-[#333] rounded p-3 flex-1 text-primary font-bold">${State.teams.map(t=>`<option value="${t.id}">${t.name}</option>`)}</select>
                                <span class="text-gray-600 font-black">VS</span>
                                <select id="sel-away" class="bg-black border border-[#333] rounded p-3 flex-1 text-secondary font-bold">${State.teams.map(t=>`<option value="${t.id}">${t.name}</option>`)}</select>
                            </div>
                        </div>
                    </div>
                    <button onclick="Act.start()" class="btn w-full p-4 bg-primary text-white text-lg font-bold mb-4 shadow-lg shadow-blue-900/30">START GAME</button>
                    <div class="grid grid-cols-2 gap-3 border-t border-[#333] pt-6">
                        <button onclick="Act.createTeam()" class="btn py-3 bg-card text-gray-400 hover:bg-[#222]">TEAMS</button>
                        <button onclick="Act.setView('HISTORY')" class="btn py-3 bg-card text-gray-400 hover:bg-[#222]">HISTORY</button>
                    </div>
                </div>
            </div>
        `;

        const HistoryListView = () => `
            <div class="history-view h-full flex flex-col bg-panel">
                <div class="p-4 border-b border-[#333] flex justify-between items-center bg-black">
                    <h2 class="font-bold">MATCH HISTORY</h2>
                    <button onclick="Act.setView('SETUP')" class="btn px-4 bg-[#333]">BACK</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                    ${State.history.length===0 ? '<div class="text-center text-gray-500 mt-8">No games saved.</div>' : ''}
                    ${State.history.map(h => `
                        <div class="bg-card border border-[#333] rounded-lg p-4 mb-3 flex justify-between items-center hover:bg-[#222] cursor-pointer" onclick="Act.viewReport('${h.id}')">
                            <div>
                                <div class="text-xs text-gray-500">${h.info.date}</div>
                                <div class="font-bold mb-1">${h.info.title}</div>
                                <div class="flex gap-3 text-sm font-mono">
                                    <span class="text-primary font-bold">${h.A.name}</span>
                                    <span class="bg-black px-2 rounded border border-[#333]">${h.finalScore.A} - ${h.finalScore.B}</span>
                                    <span class="text-secondary font-bold">${h.B.name}</span>
                                </div>
                            </div>
                            <div class="text-gray-500 text-xs">VIEW ></div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        const ReportView = () => {
            const m = State.history.find(h => h.id === State.reportId);
            if(!m) return Act.setView('HISTORY');
            
            const sc = m.finalScore.detail || calcScores(m);
            
            const BoxScoreTable = (side) => {
                const tm = m[side];
                const rows = tm.players.map(p => {
                    const s = p.stats;
                    if(s.pts+s.fga+s.pf+s.tov === 0 && !p.isOnCourt) return ''; 
                    return `<tr>
                        <td class="font-mono text-center">${p.number}</td>
                        <td class="font-bold truncate" style="max-width:100px;">${p.name}</td>
                        <td class="text-right font-bold">${s.pts}</td>
                        <td class="text-right">${s.orb+s.drb}</td>
                        <td class="text-right">${s.ast}</td>
                        <td class="text-right">${s.tov}</td>
                        <td class="text-right">${s.fgm}/${s.fga}</td>
                        <td class="text-right text-xs text-gray-400 print-text-black">${pct(s.fgm,s.fga)}%</td>
                        <td class="text-right">${s.tpm}/${s.tpa}</td>
                        <td class="text-right text-xs text-gray-400 print-text-black">${pct(s.tpm,s.tpa)}%</td>
                        <td class="text-right">${s.ftm}/${s.fta}</td>
                        <td class="text-right text-xs text-gray-400 print-text-black">${pct(s.ftm,s.fta)}%</td>
                        <td class="text-right">${s.pf}</td>
                    </tr>`;
                }).join('');
                
                const t = tm.players.reduce((a,p)=>{
                    const s=p.stats; a.pts+=s.pts; a.reb+=(s.orb+s.drb); a.ast+=s.ast; a.tov+=s.tov;
                    a.fgm+=s.fgm; a.fga+=s.fga; a.tpm+=s.tpm; a.tpa+=s.tpa; a.ftm+=s.ftm; a.fta+=s.fta; a.pf+=s.pf; return a;
                }, {pts:0,reb:0,ast:0,tov:0,fgm:0,fga:0,tpm:0,tpa:0,ftm:0,fta:0,pf:0});

                return `
                    <div class="mb-6 report-card">
                        <div class="report-card-title font-bold text-lg mb-2 border-b-2 ${side==='A'?'border-blue-500 text-blue-500 print-text-black':'border-red-500 text-red-500 print-text-black'}">${tm.name}</div>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-[#222] text-gray-300 print-bg-gray">
                                <tr>
                                    <th class="p-1">#</th><th class="p-1">Name</th><th class="p-1 text-right">PTS</th><th class="p-1 text-right">RB</th><th class="p-1 text-right">AS</th><th class="p-1 text-right">TO</th>
                                    <th class="p-1 text-right">FG</th><th class="p-1 text-right">%</th>
                                    <th class="p-1 text-right">3P</th><th class="p-1 text-right">%</th>
                                    <th class="p-1 text-right">FT</th><th class="p-1 text-right">%</th>
                                    <th class="p-1 text-right">PF</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                            <tfoot class="font-bold bg-[#222] print-bg-gray">
                                <tr>
                                    <td colspan="2" class="text-center">TOTAL</td>
                                    <td class="text-right">${t.pts}</td><td class="text-right">${t.reb}</td><td class="text-right">${t.ast}</td><td class="text-right">${t.tov}</td>
                                    <td class="text-right">${t.fgm}/${t.fga}</td><td class="text-right">${pct(t.fgm,t.fga)}%</td>
                                    <td class="text-right">${t.tpm}/${t.tpa}</td><td class="text-right">${pct(t.tpm,t.tpa)}%</td>
                                    <td class="text-right">${t.ftm}/${t.fta}</td><td class="text-right">${pct(t.ftm,t.fta)}%</td>
                                    <td class="text-right">${t.pf}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            };

            return `
                <div class="report-view h-full flex flex-col bg-panel overflow-auto custom-scrollbar">
                    <div class="no-print p-4 border-b border-[#333] flex justify-between items-center bg-black sticky top-0 z-10">
                        <div class="font-bold">GAME REPORT</div>
                        <div class="flex gap-2">
                            <button onclick="Act.printReport()" class="btn px-4 bg-success text-black font-bold text-sm">${Icons.Print} Print / PDF</button>
                            <button onclick="Act.setView('HISTORY')" class="btn px-4 bg-[#333]">CLOSE</button>
                        </div>
                    </div>
                    
                    <div class="report-container p-6 max-w-4xl mx-auto w-full bg-white text-black min-h-screen">
                        <div class="print-header text-center mb-6">
                            <div class="print-date text-sm text-gray-600 mb-1">${m.info.date}</div>
                            <h1 class="print-title text-2xl font-black uppercase mb-4">${m.info.title}</h1>
                            
                            <div class="print-scoreboard flex items-center justify-center gap-8 mb-6 border-b border-gray-300 pb-6">
                                <div class="print-team-name text-xl font-bold text-blue-600 print-text-black text-right flex-1">${m.A.name}</div>
                                <div class="print-score-val text-4xl font-mono font-black whitespace-nowrap mx-2">${m.finalScore.A} - ${m.finalScore.B}</div>
                                <div class="print-team-name text-xl font-bold text-red-600 print-text-black text-left flex-1">${m.B.name}</div>
                            </div>
                            
                            <div class="print-period-container flex justify-center mb-8">
                                <table class="print-period-table w-auto text-sm border border-gray-300">
                                    <thead class="bg-gray-100">
                                        <tr><th class="px-4 py-1">Team</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>OT</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="font-bold px-4">${m.A.name}</td><td>${sc.A[0]}</td><td>${sc.A[1]}</td><td>${sc.A[2]}</td><td>${sc.A[3]}</td><td>${sc.A[4]}</td></tr>
                                        <tr><td class="font-bold px-4">${m.B.name}</td><td>${sc.B[0]}</td><td>${sc.B[1]}</td><td>${sc.B[2]}</td><td>${sc.B[3]}</td><td>${sc.B[4]}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${BoxScoreTable('A')}
                        ${BoxScoreTable('B')}
                        
                        <div class="print-footer mt-8 text-center text-xs text-gray-400 pt-4 border-t">Generated by Basketball Stats Pro</div>
                    </div>
                </div>
            `;
        };

        const TeamEditView = () => {
            const t = State.teams.find(x => x.id === State.editTeamId);
            return `
            <div class="flex flex-col h-full bg-panel">
                <div class="p-4 border-b border-[#333] flex justify-between items-center bg-black sticky top-0 z-10">
                    <h2 class="font-bold">EDIT TEAM</h2>
                    <button onclick="Act.setView('SETUP')" class="btn px-4 py-1 bg-success text-black font-bold text-sm">DONE</button>
                </div>
                <div class="p-4 flex-1 overflow-hidden flex flex-col max-w-2xl mx-auto w-full">
                    <div class="mb-4">
                        <label class="text-xs text-gray-500">TEAM NAME</label>
                        <input value="${t.name}" oninput="Act.updateTeamName(this.value)" class="text-lg font-bold mt-1 bg-black border border-[#333] rounded p-2 w-full focus:border-primary">
                    </div>
                    <div class="flex justify-between items-center mb-2 mt-2">
                        <span class="text-xs text-gray-500 font-bold">ROSTER</span>
                        <button onclick="Act.addPlayer()" class="btn px-3 py-1 text-xs bg-white/10 hover:bg-white/20">${Icons.Plus} ADD</button>
                    </div>
                    <div class="custom-scrollbar flex-1 -mx-2 px-2">
                        ${t.players.map(p => `
                            <div class="flex items-center gap-2 mb-2 bg-card p-2 rounded border border-[#333]">
                                <input value="${p.number}" placeholder="#" onchange="Act.updatePlayer('${p.id}','number',this.value)" class="w-12 text-center font-mono font-bold bg-black border border-[#444] rounded p-1 focus:border-primary">
                                <input value="${p.name}" placeholder="Name" onchange="Act.updatePlayer('${p.id}','name',this.value)" class="flex-1 bg-transparent border-none focus:bg-black focus:border-b p-1">
                                <button onclick="Act.removePlayer('${p.id}')" class="btn text-gray-500 hover:text-red-500 p-2">${Icons.Trash}</button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="Act.deleteTeam('${t.id}');Act.setView('SETUP')" class="mt-4 btn w-full p-3 border border-red-900/50 text-red-500 hover:bg-red-900/10">DELETE TEAM</button>
                </div>
            </div>
            `;
        };

        const GameView = () => {
            const m = State.match;
            const t = State.target;
            const sc = calcScores(m);
            const activeP = t.id ? (m.A.players.find(p=>p.id===t.id) || m.B.players.find(p=>p.id===t.id)) : null;

            const Indicators = (label, current, max, colorClass, align) => `
                <div class="flex items-center gap-1 ${align==='right'?'flex-row-reverse':''}">
                    <div class="text-[9px] font-bold text-gray-500 w-4 text-center">${label}</div>
                    <div class="flex gap-1">
                        ${Array.from({length:max}).map((_,i) => `<div class="w-3 h-3 rounded-full border border-[#444] ${i < current ? colorClass : 'bg-[#1a1a1a]'}"></div>`).join('')}
                    </div>
                </div>
            `;
            const TimeoutBtn = (side, align) => `<div onclick="Act.timeout('${side}')" class="cursor-pointer p-1 rounded hover:bg-white/5 active:bg-white/10 transition-colors">${Indicators('TO', getTOTaken(m, side), getTOLimit(m.period), 'bg-blue-500 border-blue-500 shadow-[0_0_4px_#3b82f6]', align)}</div>`;
            const FoulDisplay = (side, align) => Indicators('TF', getTeamFouls(m, side), 4, 'bg-red-500 border-red-500 shadow-[0_0_4px_#ef4444]', align);
            const PeriodLabel = (p) => p > 4 ? `OT${p-4}` : `Q${p}`;

            // --- Helper to generate Action Buttons with Active State ---
            const ActionBtn = (key, label, sub, type='') => {
                const isActive = State.activeAction === key ? 'selected' : '';
                return `<button onclick="Act.stat('${key}')" class="act-btn ${type} ${isActive} col-span-1 row-span-1"><span class="text-${type==='make'||type==='miss'?'xl':'lg'} font-black ${type==='make'?'italic':type==='miss'?'italic text-gray-500':''}">${label}</span><span class="text-[9px] ${type==='miss'?'text-gray-500':''}">${sub}</span></button>`;
            };

            const ActionGrid = `
                <div class="grid grid-cols-4 grid-rows-3 gap-2 h-full">
                    ${ActionBtn('3PM', '3P', 'MAKE', 'make')}
                    ${ActionBtn('2PM', '2P', 'MAKE', 'make')}
                    ${ActionBtn('FTM', 'FT', 'MAKE', 'make')}
                    ${ActionBtn('ORB', 'ORB', '', 'text-gray-300 hover:bg-[#333]')}

                    ${ActionBtn('3PX', '3P', 'MISS', 'miss')}
                    ${ActionBtn('2PX', '2P', 'MISS', 'miss')}
                    ${ActionBtn('FTX', 'FT', 'MISS', 'miss')}
                    ${ActionBtn('DRB', 'DRB', '', 'text-gray-300 hover:bg-[#333]')}

                    ${ActionBtn('AST', 'AST', '', 'text-accent hover:bg-[#333] border-accent/30')}
                    ${ActionBtn('TOV', 'TO', '', 'text-gray-400 hover:bg-[#333]')}
                    ${ActionBtn('PF', 'PF', '', 'text-red-500 hover:bg-[#333] border-red-900/50')}
                    <button onclick="State.modals.sub=true;Render()" class="act-btn text-gray-500 hover:bg-[#333] border-gray-800"><span class="text-lg font-bold">SUB</span></button>
                </div>
            `;
            
            const Controls = `<div class="flex gap-1 h-full"><button onclick="Act.undo()" class="btn flex-1 bg-card hover:bg-white/10 text-gray-400">${Icons.Undo}</button><button onclick="State.modals.stats=true;Render()" class="btn flex-1 bg-card hover:bg-white/10 text-gray-400">STATS</button><button onclick="State.modals.log=true;Render()" class="btn flex-1 bg-card hover:bg-white/10 text-gray-400">LOG</button><button onclick="State.modals.end=true;Render()" class="btn flex-1 bg-card hover:bg-white/10 text-red-800">${Icons.Exit}</button></div>`;
            const PRoster = (side) => `<div class="horizontal-scroll gap-2 p-2 h-full items-center bg-[#111] border-b border-[#333] ${side==='A'?'border-t border-[#333]':''}"><div class="flex-shrink-0 w-8 flex items-center justify-center font-bold text-xs ${side==='A'?'text-primary':'text-secondary'} writing-mode-vertical" style="writing-mode: vertical-rl;">${side==='A'?'HOME':'AWAY'}</div>${m[side].players.filter(p=>p.isOnCourt).map(p=>`<div onclick="Act.sel('${side}','${p.id}')" class="p-player-card ${t.id===p.id?'active bg-'+(side==='A'?'primary':'secondary'):''}"><div class="font-mono font-bold text-lg leading-none">${p.number}</div><div class="text-[9px] truncate w-14 text-center text-gray-400 leading-tight">${p.name}</div>${p.stats.pf>0 ? `<div class="absolute top-0 right-0 w-2 h-2 rounded-full ${p.stats.pf>=4?'bg-red-500':'bg-yellow-500'}"></div>`:''}</div>`).join('')}<button onclick="State.target.side='${side}';State.modals.sub=true;Render()" class="p-player-card border-dashed opacity-50"><span class="text-[10px]">SUB</span></button></div>`;
            const LRoster = (side) => m[side].players.filter(p=>p.isOnCourt).map(p => `<div onclick="Act.sel('${side}','${p.id}')" class="p-2 border-b border-[#333] flex items-center gap-2 cursor-pointer ${t.id===p.id? (side==='A'?'bg-primary':'bg-secondary') : 'hover:bg-[#222]'}"><div class="font-mono font-bold w-6 text-center text-gray-400">${p.number}</div><div class="flex-1 font-bold text-xs truncate">${p.name}</div><div class="text-[10px] font-mono text-gray-500">P:${p.stats.pts} F:${p.stats.pf}</div></div>`).join('');

            // Modals
            const PeriodModal = () => !State.modals.period ? '' : `<div class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target===this){State.modals.period=false;Render()}"><div class="bg-card w-full max-w-xs rounded-lg border border-[#444] p-4"><h3 class="text-center font-bold mb-4 text-gray-400">SELECT PERIOD</h3><div class="grid grid-cols-2 gap-2">${[1,2,3,4,5,6].map(p=>`<button onclick="Act.setPeriod(${p})" class="btn p-4 border border-[#333] font-black text-xl hover:bg-white/10 ${m.period===p?'bg-primary text-white border-primary':''}">${p>4?'OT'+(p-4):'Q'+p}</button>`).join('')}</div></div></div>`;
            const SubModal = () => !State.modals.sub ? '' : `<div class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4" onclick="if(event.target===this){State.modals.sub=false;Render()}"><div class="bg-card w-full max-w-sm rounded-lg border border-[#444] flex flex-col max-h-[80vh]"><div class="p-3 border-b border-[#333] font-bold text-center">SUBSTITUTION</div><div class="flex-1 overflow-y-auto p-2"><div class="text-xs text-center mb-1 text-red-400">OUT (ON COURT)</div><div class="grid grid-cols-2 gap-2 mb-4">${(m[t.side||'A']).players.filter(p=>p.isOnCourt).map(p=>`<button onclick="window.subOut='${p.id}';this.style.borderColor='red'" class="btn border border-[#333] p-2 bg-black justify-between"><span class="font-mono text-lg">${p.number}</span><span class="text-xs truncate ml-2">${p.name}</span></button>`).join('')}</div><div class="text-xs text-center mb-1 text-blue-400">IN (BENCH)</div><div class="grid grid-cols-2 gap-2">${(m[t.side||'A']).players.filter(p=>!p.isOnCourt).map(p=>`<button onclick="window.subIn='${p.id}';this.style.borderColor='#3b82f6'" class="btn border border-[#333] p-2 bg-black justify-between"><span class="font-mono text-lg">${p.number}</span><span class="text-xs truncate ml-2">${p.name}</span></button>`).join('')}</div></div><button onclick="if(window.subOut&&window.subIn)Act.sub('${t.side||'A'}',window.subOut,window.subIn)" class="p-4 bg-white text-black font-bold m-2 rounded">CONFIRM</button></div></div>`;
            const LogModal = () => !State.modals.log ? '' : `<div class="fixed inset-0 z-50 bg-black/90 flex flex-col p-4 animate-fade-in"><div class="flex justify-between items-center mb-4"><h2 class="font-bold">GAME LOG</h2><button onclick="State.modals.log=false;Render()" class="btn px-4 bg-[#333]">CLOSE</button></div><div class="flex-1 overflow-y-auto custom-scrollbar">${m.log.map(l=>`<div class="border-b border-[#222] py-2 flex gap-2 text-xs"><span class="font-mono text-gray-500">${l.time}</span><span class="font-bold ${l.side==='A'?'text-primary':'text-secondary'}">${l.side}</span> <span class="flex-1">${l.txt}</span> ${l.pts?`<span class="text-white font-bold">+${l.pts}</span>`:''}</div>`).join('')}</div></div>`;
            const StatsModal = () => !State.modals.stats ? '' : `<div class="fixed inset-0 z-50 bg-black/90 flex flex-col p-6"><div class="flex justify-between mb-4"><h2 class="font-bold">BOX SCORE</h2><button onclick="State.modals.stats=false;Render()" class="btn px-4 bg-[#333]">CLOSE</button></div><div class="flex-1 overflow-y-auto">${['A','B'].map(s=>`<div class="mb-6"><div class="font-bold mb-2 ${s==='A'?'text-primary':'text-secondary'}">${m[s].name}</div><table class="w-full text-xs text-left"><thead><tr class="text-gray-500 border-b border-[#333]"><th>#</th><th>PTS</th><th>REB</th><th>AST</th><th>PF</th></tr></thead><tbody>${m[s].players.map(p=>`<tr class="border-b border-[#222]"><td class="py-2 font-mono text-gray-500">${p.number}</td><td class="font-bold text-white">${p.stats.pts}</td><td>${p.stats.orb+p.stats.drb}</td><td>${p.stats.ast}</td><td>${p.stats.pf}</td></tr>`).join('')}</tbody></table></div>`).join('')}</div></div>`;
            const EndModal = () => !State.modals.end ? '' : `<div class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur"><div class="bg-card border border-[#333] p-6 rounded-lg w-80 text-center shadow-2xl"><h3 class="font-bold text-xl mb-4 text-white">FINISH GAME?</h3><button onclick="Act.finish(true)" class="btn w-full p-3 bg-primary text-white font-bold mb-2">SAVE & EXIT</button><button onclick="State.modals.end=false;Render()" class="btn w-full p-3 text-gray-500">CANCEL</button></div></div>`;

            return `
                ${SubModal()}${LogModal()}${StatsModal()}${EndModal()}${PeriodModal()}
                
                <div class="portrait-layout">
                    <div class="flex items-center justify-between px-4 py-2 bg-panel border-b border-[#333] h-16 shrink-0 rounded-lg mx-2 mb-1">
                        <div class="flex flex-col items-start gap-1"><div class="text-3xl font-black text-primary font-mono leading-none">${sc.At}</div><div class="flex flex-col gap-1">${TimeoutBtn('A')}${FoulDisplay('A')}</div></div>
                        <div class="flex flex-col items-center cursor-pointer active:scale-95 transition-transform" onclick="State.modals.period=true;Render()"><div class="text-xl font-black text-white font-mono border-b-2 border-accent/50 px-2">${PeriodLabel(m.period)}</div><div class="text-[10px] text-gray-600 font-mono mt-0.5">${nowTime()}</div></div>
                        <div class="flex flex-col items-end gap-1"><div class="text-3xl font-black text-secondary font-mono leading-none">${sc.Bt}</div><div class="flex flex-col items-end gap-1">${TimeoutBtn('B', 'right')}${FoulDisplay('B', 'right')}</div></div>
                    </div>
                    <div class="h-20 bg-black shrink-0">${PRoster('A')}</div>
                    <div class="flex-1 flex flex-col bg-black min-h-0 rounded-lg mx-1 border border-[#222]">
                        <div class="h-8 flex items-center justify-center border-b border-[#333] bg-[#1a1a1a] rounded-t-lg shrink-0">
                            ${activeP ? `<span class="px-3 py-0.5 rounded text-xs font-bold ${t.side==='A'?'bg-primary text-white':'bg-secondary text-white'}">#${activeP.number} ${activeP.name}</span>` : `<span class="text-[10px] text-gray-600 tracking-widest">SELECT PLAYER</span>`}
                            ${m.log.length>0 ? `<span class="absolute right-2 text-[9px] text-gray-500 truncate max-w-[100px]">${m.log[0].txt}</span>`:''}
                        </div>
                        <div class="flex-1 p-2 overflow-hidden">${ActionGrid}</div>
                        <div class="h-12 p-2 border-t border-[#333] shrink-0">${Controls}</div>
                    </div>
                    <div class="h-20 bg-black shrink-0">${PRoster('B')}</div>
                </div>

                <div class="landscape-layout">
                    <div class="bg-panel border-b border-[#333] h-14 grid grid-cols-3 px-4 items-center gap-4">
                        <div class="flex items-center gap-3"><div class="font-bold text-primary truncate text-sm w-32">${m.A.name}</div><div class="flex flex-col gap-1 border-l border-[#333] pl-3">${TimeoutBtn('A')}${FoulDisplay('A')}</div></div>
                        <div class="flex items-center justify-center gap-4"><div class="text-3xl font-mono font-black tracking-tighter">${sc.At} - ${sc.Bt}</div><div class="flex flex-col items-center"><button onclick="State.modals.period=true;Render()" class="font-black text-lg text-accent border border-accent/30 px-2 rounded hover:bg-accent/10 leading-none mb-1">${PeriodLabel(m.period)}</button><span class="text-[10px] text-gray-500 font-mono leading-none">${nowTime()}</span></div></div>
                        <div class="flex items-center gap-3 justify-end"><div class="flex flex-col items-end gap-1 border-r border-[#333] pr-3">${TimeoutBtn('B', 'right')}${FoulDisplay('B', 'right')}</div><div class="font-bold text-secondary truncate text-sm text-right w-32">${m.B.name}</div></div>
                    </div>
                    <div class="cockpit-grid">
                        <div class="border-r border-[#333] flex flex-col"><div class="bg-[#111] text-[10px] text-center text-gray-500 py-1">HOME LOG</div><div class="flex-1 custom-scrollbar bg-panel text-[10px] p-1">${m.log.filter(l=>l.side==='A').map(l=>`<div class="border-b border-[#222] py-1 text-gray-400">${l.time} ${l.txt}</div>`).join('')}</div></div>
                        <div class="border-r border-[#333] flex flex-col"><div class="bg-[#111] text-[10px] text-center text-gray-500 py-1">HOME ROSTER</div><div class="flex-1 custom-scrollbar bg-panel">${LRoster('A')}</div></div>
                        <div class="flex flex-col bg-black">
                             <div class="h-8 flex items-center justify-center border-b border-[#333] bg-[#1a1a1a]">
                                ${activeP ? `<span class="px-3 py-0.5 rounded text-xs font-bold ${t.side==='A'?'bg-primary text-white':'bg-secondary text-white'}">#${activeP.number} ${activeP.name}</span>` : `<span class="text-[10px] text-gray-600 tracking-widest">SELECT PLAYER</span>`}
                            </div>
                            <div class="flex-1 p-4">${ActionGrid}</div>
                            <div class="h-12 p-2 border-t border-[#333]">${Controls}</div>
                        </div>
                        <div class="border-r border-[#333] flex flex-col"><div class="bg-[#111] text-[10px] text-center text-gray-500 py-1">AWAY ROSTER</div><div class="flex-1 custom-scrollbar bg-panel">${LRoster('B')}</div></div>
                        <div class="flex flex-col"><div class="bg-[#111] text-[10px] text-center text-gray-500 py-1">AWAY LOG</div><div class="flex-1 custom-scrollbar bg-panel text-[10px] p-1">${m.log.filter(l=>l.side==='B').map(l=>`<div class="border-b border-[#222] py-1 text-gray-400">${l.time} ${l.txt}</div>`).join('')}</div></div>
                    </div>
                </div>
            `;
        };

        load();
        window.addEventListener('resize', Render);
        Render();
    </script>
</body>
</html>

